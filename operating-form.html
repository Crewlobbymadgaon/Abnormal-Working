<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Operating Forms ‚Äî Abnormal Working Style</title>
<style>
:root {
  --header-height: 88px;
  --accent-blue: #1976d2;
  --accent-green: #388e3c;
  --muted: #6b7280;
  --card-font-mid: 1.6vw;
}

/* Basic page shell */
html, body {
  height: 100%;
  margin: 0;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  background: #f9f9f9;
  color: #222;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

header {
  height: var(--header-height);
  min-height: var(--header-height);
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  position: sticky;
  top: 0;
  z-index: 110;
  padding: 0 20px;
  box-sizing: border-box;
}

#mainHeading {
  color: #fff;
  margin: 0;
  font-weight: 800;
  text-align: center;
  font-size: clamp(1rem, 3.0vw, 1.6rem);
  display: flex;
  flex-direction: column;
  gap: 2px;
  align-items: center;
  justify-content: center;
  height: 100%;
  box-sizing: border-box;
  padding: 10px 52px;
}

/* Container & home tiles */
.card-surface {
  padding: 12px;
  max-width: 980px;
  margin: 18px auto;
}
.block-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 30px;
  flex-wrap: wrap;
  margin-top: 50px;
  padding: 0 20px;
}

/* ===== Clean unified home tile style ===== */
.block {
  flex: 1 1 260px;
  max-width: 340px;
  min-height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 16px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
  padding: 18px 22px;
  box-sizing: border-box;
  cursor: pointer;
  text-align: center;
  font-weight: 900;
  letter-spacing: 0.5px;
  
  user-select: none;
  transition: transform .20s ease, box-shadow .20s ease, background .18s ease, border-color .18s ease;
  position: relative;
  overflow: hidden;
  background: #ffffff !important;
  border: 3px solid rgba(0,0,0,0.06);
  color: inherit;
}

/* Blue & Green outline variants */
.block.abs {
  border-color: #1976d2;
  color: #0f4fa8;
  background: #fff !important;      
}
.block.auto {
  border-color: #2e7d32;
  color: #1f6f2f;
  background: #fff !important;      
}

/* Larger, responsive text */
.block, .block * {
  font-size: clamp(18px, 3.8vw, 26px);
  font-weight: 900;
  line-height: 1;
  color: inherit;
}

/* Hover & active effects */
.block:hover, .block:focus {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 20px 40px rgba(0,0,0,0.12);
  outline: none;
}
.block:active {
  transform: translateY(2px) scale(0.97);
}

/* Responsive tweaks */
@media (max-width:720px) {
  .block, .block * { font-size: clamp(22px, 6.5vw, 34px); }
  .block { min-height: 140px; max-width: 92%; }
}
@media (max-width:420px) {
  .block, .block * { font-size: clamp(18px, 3.8vw, 26px); }
  .block { min-height: 120px; }
}

/* Grid of forms */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 18px;
  margin: 20px auto;
  max-width: 980px;
  align-content: start;
}
.tile {
  display: flex;
  flex-direction: column;
  gap: 12px;
  padding: 18px;
  border-radius: 14px;
  background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(250,250,252,0.98));
  border: 1px solid rgba(14,20,30,0.03);
  box-shadow: 0 18px 40px rgba(18,28,46,0.06);
  text-align: center;
  transition: transform .18s ease, box-shadow .18s ease;
}
.auth-number { font-weight: 900; font-size: 1.15rem; color: #071133; }
.auth-desc { color: var(--muted); font-size: 0.95rem; line-height: 1.35; min-height: 2.4em; }
.tile-actions { display: flex; justify-content: center; margin-top: 6px; }
.btn-view {
  padding: 10px 18px;
  border-radius: 999px;
  border: 0;
  cursor: pointer;
  font-weight: 900;
  color: #fff;
  min-width: 140px;
  background: linear-gradient(90deg, var(--accent-blue), #0f63b8);
}
.tile.auto .btn-view, .tile.ats .btn-view {
  background: linear-gradient(90deg, var(--accent-green), #2e8a3a);
}

/* Pills */
.menu-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 12px 20px;
  border-radius: 999px;
  font-weight: 800;
  color: #fff;
  background: var(--accent-blue);
  border: 0;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(25,118,210,0.12);
}

/* Subheader */
.subheader {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  padding: 10px 16px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  position: sticky;
  top: var(--header-height);
  z-index: 109;
  box-sizing: border-box;
  gap: 8px;
  min-height: 64px;
}
.subheader[aria-hidden="true"] { border-bottom: none; box-shadow: none; }
/* === Make main header fixed and ensure layout doesn't jump === */
/* Put near your existing CSS (or paste into head) */
header#mainHeaderFixed {
  position: fixed !important;
  top: 0;
  left: 0;
  right: 0;
  z-index: 400;
  will-change: transform;
  /* keep same visuals (if your header styles were on header element already) */
  box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}

/* Ensure subheader sits below main header using CSS var for header height */
.subheader.fixed-subheader {
  position: fixed !important;
  top: var(--header-height);
  left: 0;
  right: 0;
  z-index: 390;
}

/* Spacer style (inserted by JS) */
#mainHeaderSpacer {
  display: block;
  width: 100%;
  height: var(--header-height); /* default; JS will set exact px value */
  pointer-events: none;
  background: transparent;
}

/* Make sure main content has no extra stacking context that would break fixed header.
   Avoid setting overflow on parent elements of .subheader. If you do, prefer fixed approach. */

/* Circular sub-actions */
.sub-action {
  width: 44px;
  height: 44px;
  min-width: 44px;
  min-height: 44px;
  border-radius: 50%;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: 0;
  color: #fff;
  background: var(--accent-blue);
  box-shadow: 0 6px 18px rgba(0,0,0,0.18);
  cursor: pointer;
  transition: transform .16s ease, box-shadow .16s ease;
  line-height: 0;
}
.sub-action.menu { background: var(--accent-green); }
.sub-action svg { width: 18px; height: 18px; display: block; }
.sub-action.hidden { display: none !important; }

.subheader .back-flow {
  position: absolute; left: 12px; top: 50%; transform: translateY(-50%); z-index: 12;
}
.subheader .menu-flow {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%); z-index: 12;
}

/* System title pill */
#systemSubInner {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 44px;
  min-width: 44px;
  padding: 0 14px;
  border-radius: 999px;
  background: #fff;
  border: 1px solid rgba(0,0,0,0.06);
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
  margin: 0 auto;
  box-sizing: border-box;
}
#systemTitle {
  font-size: 1.02rem;
  color: #111;
  font-weight: 800;
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Back pill */
#homeBackPill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 14px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 0.95rem;
  color: #fff;
  background: var(--accent-blue);
  border: 0;
  box-shadow: 0 8px 20px rgba(25,118,210,0.12);
  cursor: pointer;
  transition: transform .12s ease, box-shadow .12s ease;
  margin-top: 34px;
}
#homeBackPill:active { transform: translateY(1px) scale(.995); }

/* Overlay & side menu */
#overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.36);
  opacity: 0;
  pointer-events: none;
  transition: opacity .18s ease;
  z-index: 220;
}
#overlay.show { opacity: 1; pointer-events: auto; }

#sideMenu {
  position: fixed; right: -340px; top: 0;
  height: 100vh; width: 320px; max-width: 92%;
  background: #fff;
  box-shadow: -8px 0 24px rgba(0,0,0,0.18);
  transition: right .26s cubic-bezier(.2,.9,.2,1);
  z-index: 230;
  padding: 16px;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  gap: 12px;
}
#sideMenu.open { right: 0; }
#sideMenu h3 { margin: 0; font-size: 1rem; font-weight: 800; color: #111; }
#sideMenu .close-btn {
  align-self: flex-end;
  background: transparent;
  border: 0;
  font-weight: 700;
  cursor: pointer;
  color: #1976d2;
}
#sideMenu .menu-list {
  list-style: none;
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow: auto;
}
#sideMenu .menu-list button {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.06);
  background: #fff;
  cursor: pointer;
  text-align: left;
  font-weight: 700;
}
#sideMenu .menu-list button:hover {
  background: #f6fbff;
  box-shadow: 0 8px 20px rgba(25,118,210,0.06);
}

/* Hide legacy header back by default */
#headerBack { display: none; }
#headerBack.visible { display: inline-flex; }

button:focus {
  outline: 3px solid rgba(25,118,210,0.18);
  outline-offset: 2px;
}
  /* --- Compact side menu --- */
  #sideMenu {
    width: 280px;
    max-width: 88%;
    padding: 50px 16px 18px;
    box-shadow: -6px 0 20px rgba(0,0,0,0.15);
    border-left: 1px solid rgba(0,0,0,0.05);
    border-top-left-radius: 12px;
  }

  /* --- Home button --- */
  #sideHomeBtn {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,0.08);
    background: #fff;
    cursor: pointer;
    font-weight: 900;
    font-size: 1.08rem;
    margin-bottom: 12px;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  #sideHomeBtn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(25,118,210,0.12);
  }

  /* --- Smaller circular Close button --- */
  #sideCloseBtn {
    position: absolute;
    top: 10px;
    right: 12px;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: none;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-green));
    box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(255,255,255,0.85);
    font-size: 1.05rem;
    font-weight: bold;
    transition: transform .25s ease, box-shadow .25s ease, color .2s ease;
  }
  #sideCloseBtn:hover {
    transform: scale(1.08);
    box-shadow: 0 6px 14px rgba(25,118,210,0.28);
    color: rgba(255,255,255,0.95);
  }

  /* ‚úï symbol */
  #sideCloseBtn::before {
    content: "‚úï";
    font-size: 1.1rem;
    line-height: 1;
    color: inherit;
  }
</style>
</head>
<body>
<header>
  <!-- legacy header back (hidden) -->
  <button id="headerBack" class="back-btn hidden" aria-hidden="true" title="Back (legacy)">
    <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 12H5M12 5l-7 7 7 7" stroke="currentColor" stroke-width="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <h1 id="mainHeading">OPERATING FORMS</h1>
</header>

<!-- Subheader -->
<div id="systemSubheader" class="subheader" style="display:none;" aria-hidden="true">
  <div class="back-flow">
    <button id="subBackBtn" class="sub-action hidden" aria-label="Back to systems" title="Back to systems">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
        <path d="M19 12H5M12 5l-7 7 7 7" stroke="currentColor" stroke-width="2.4" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
  </div>

  <div id="systemSubInner" aria-hidden="true">
    <div id="systemTitle" style="font-weight:800;font-size:1.05rem;color:#111"></div>
  </div>

  <div class="menu-flow">
    <button id="subMenuBtn" class="sub-action menu hidden" aria-label="Open quick list" title="Open quick list">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z" fill="currentColor"/></svg>
    </button>
  </div>
</div>

<main class="card-surface" role="main">
  <div id="homePills">
    <div class="block-container" id="categoryContainer" role="list">
      <div class="block abs" id="pillABS" data-system="Absolute Block System" tabindex="0" role="button" aria-pressed="false">Absolute Block System</div>
      <div class="block auto" id="pillATS" data-system="Automatic Block Section" tabindex="0" role="button" aria-pressed="false">Automatic Block Section</div>
    </div>

    <!-- Home small back pill -->
    <div style="width:100%;text-align:center;">
      <button id="homeBackPill" type="button" aria-label="Back" style="display:inline-flex;">
        Back
      </button>
    </div>

    <div style="width:100%;text-align:center;margin-top:20px;">
      <button id="bottomBack" class="menu-pill" type="button" aria-label="Back" style="display:none;">Back</button>
    </div>
  </div>

  <!-- Forms area -->
  <div id="formsArea" style="display:none; margin-top:18px;">
    <div id="formsGrid" class="grid" role="list" aria-label="Forms list"></div>

    <div style="width:100%;text-align:center;margin-top:20px;">
      <button id="listBack" class="menu-pill" type="button" aria-label="Back to systems" style="display:none;">Back</button>
    </div>
  </div>
</main>

<!-- Overlay & Side menu -->
<div id="overlay" aria-hidden="true"></div>
<aside id="sideMenu" aria-hidden="true" role="dialog" aria-label="Quick operating forms list">
  <button class="close-btn" id="sideCloseBtn" aria-label="Close quick list">Close</button>
  <h3 id="sideMenuTitle">Quick forms</h3>
  <div id="sideMenuNote" style="color:var(--muted); font-size:0.95rem;">Select a system to see its operating forms here.</div>
  <ul class="menu-list" id="sideMenuList"></ul>
</aside>

<script>
/* ---------- Data ---------- */
const DATA = {
  "Absolute Block System": [
    { id: 'T/369(3b)', title:'Authority to Pass Signals in ON or Defective Position', desc:'Authority to Pass Signals in ON or Defective Position', file:'forms/t369.webp' },
    { id: 'T/C 1425', title:'PLCT - UP', desc:'Paper Line Clear Ticket - UP', file:'forms/tc1425.webp' },
    { id: 'T/D 1425', title:'PLCT - DN', desc:'Paper Line Clear Ticket - DN', file:'forms/td1425.webp' },
    { id: 'T/806', title:'Shunting Order', desc:'Shunting Order', file:'forms/t806.webp' },
    { id: 'T/509', title:'Authority to Receive a Train on an Obstructed Line', desc:'Authority to Receive a Train on an Obstructed Line', file:'forms/t509.webp' },
    { id: 'T/510', title:'Authority to Receive a Train on a Non-signalled Line', desc:'Authority to Receive a Train on a Non-Signalled Line', file:'forms/t510.webp' },
    { id: 'T/511', title:'Authority to Start from a Non-signalled Line', desc:'Authority to Start from a Non-Signalled Line', file:'forms/t511.webp' },
    { id: 'T/512', title:'Authority to Start from a Line with Common Starter Signal', desc:'Authority to Start from a Line with Common Starter Signal', file:'forms/t512.webp' },
    { id: 'T/A 602', title:'Authority to Proceed for Relief Engine/Train into an Occupied Block Section', desc:'Authority to Proceed for Relief Engine/Train into an Occupied Block Section', file:'forms/ta602.webp' },
    { id: 'T/B 602', title:'Authority for Opening Communication during TIC on Single Line Section', desc:'Authority for Opening Communication during Total Interruption of Communication (TIC) on Single Line Section', file:'forms/tb602.webp' },
    { id: 'T/C 602', title:'Authority for Working of Train during TIC on Double Line Section', desc:'Authority for Working of Train during Total Interruption of Communication (TIC) on Double Line Section', file:'forms/tc602.webp' },
    { id: 'T/D 602', title:'Authority for TSL working on Double Line Section', desc:'Authority fir Temporary Single Line (TSL) working on Double Line Section', file:'forms/td602.webp' },
    { id: 'T/E 602', title:'Line Clear Enquiry Message', desc:'Line Clear Enquiry Message - asking Line Clear for despatch of trains during Total Failure of Communication on Single Line Section', file:'forms/te602.webp' },
    { id: 'T/F 602', title:'Conditional Line Clear Message', desc:'Condtional Line Clear Message', file:'forms/tf602.webp' },
    { id: 'T/G 602', title:'Conditional Line Clear Ticket - UP', desc:'Condtional Line Clear Ticket - UP', file:'forms/tg602.webp' },
    { id: 'T/H 602', title:'Conditional Line Clear Ticket - DN', desc:'Condtional Line Clear Ticket - DN', file:'forms/th602.webp' },
    { id: 'T/609', title:'Written Permission by TMR to Loco Pilot to Proceed to next Station from Mid-section', desc:'Written Permission by TMR to Loco Pilot to Proceed to next Station from Mid-section', file:'forms/t609.webp' },
    { id: 'T 409', title:'Caution Order', desc:'Caution Order', file:'forms/t409.webp' },
    { id: 'T/A 409', title:'NIL Caution Order', desc:'NIL Caution Order', file:'forms/ta409.webp' },
    { id: 'T/B 409', title:'Reminder Caution Order', desc:'Reminder Caution Order', file:'forms/tb409.webp' }
  ],
  "Automatic Block Section": [
   
    { id: 'T/A 912', title:'Authority to Pass Automatic/Semi-Automatic/Manual Stop Signal/Gate Stop Signals', desc:'Authority to Pass Automatic/Semi-Automatic/Manual Stop Signal/Gate Stop Signals', file:'forms/ta912.webp' },
    { id: 'T/B 912', title:'Authority for Working of Trains during TIC/Obstruction on Line in Automatic Block System', desc:'Authority for Working of Trains during Total Interruption of Communication (TIC)/Obstruction on Line in Automatic Block System', file:'forms/tb912.pdf' },
    { id: 'T/C 912', title:'Authority to Proceed for Relief Engine/Train into an Automatic Block Signalling Section', desc:'Authority to Proceed for Relief Engine/Train into an Automatic Block Signalling Section', file:'forms/tc912.webp' },
    { id: 'T/D 912', title:'Authority for Working of Trains during Prolonged Signal Failure in Automatic Block System', desc:'Authority for Working of Trains during Prolonged Signal Failure in Automatic Block System', file:'forms/td912.webp' },
    { id: 'T/E 912', title:'Authority for TSL on Double Line in Automatic Block System', desc:'Authority for Temporary Single Line (TSL) Working on Double Line in Automatic Block System', file:'forms/te912.webp' }
    
  ]
};

/* ---------- Refs ---------- */
const categoryContainer = document.getElementById('categoryContainer');
const pillABS = document.getElementById('pillABS');
const pillATS = document.getElementById('pillATS');
const homePills = document.getElementById('homePills');
const formsArea = document.getElementById('formsArea');
const formsGrid = document.getElementById('formsGrid');
const bottomBack = document.getElementById('bottomBack');
const listBack = document.getElementById('listBack');

const systemSubheader = document.getElementById('systemSubheader');
const systemTitleEl = document.getElementById('systemTitle');
const homeBackPill = document.getElementById('homeBackPill');
const subBackBtn = document.getElementById('subBackBtn');
const subMenuBtn = document.getElementById('subMenuBtn');

const overlay = document.getElementById('overlay');
const sideMenu = document.getElementById('sideMenu');
const sideMenuList = document.getElementById('sideMenuList');
const sideMenuTitle = document.getElementById('sideMenuTitle');
const sideMenuNote = document.getElementById('sideMenuNote');
const sideCloseBtn = document.getElementById('sideCloseBtn');

let currentSystem = null;

/* ---------- Helpers (robust show/hide) ---------- */
function showSubheader(show = true, title = '') {
  if (!systemSubheader) return;
  if (show) {
    systemSubheader.style.display = 'flex';
    systemSubheader.setAttribute('aria-hidden','false');
    if (systemTitleEl) systemTitleEl.textContent = title;
    document.body.classList.add('has-subheader');
  } else {
    systemSubheader.style.display = 'none';
    systemSubheader.setAttribute('aria-hidden','true');
    if (systemTitleEl) systemTitleEl.textContent = '';
    document.body.classList.remove('has-subheader');
  }
}
function showHomeBackPill(show = true) {
  if (!homeBackPill) return;
  homeBackPill.style.display = show ? 'inline-flex' : 'none';
  homeBackPill.setAttribute('aria-hidden', String(!show));
}
function showSubBack(show = true) {
  if (!subBackBtn) return;
  // ensure both style and class updated (robust)
  subBackBtn.classList.toggle('hidden', !show);
  subBackBtn.style.display = show ? 'inline-flex' : 'none';
  subBackBtn.setAttribute('aria-hidden', String(!show));
}
function showMenuButton(show = true) {
  if (!subMenuBtn) return;
  subMenuBtn.classList.toggle('hidden', !show);
  subMenuBtn.style.display = show ? 'inline-flex' : 'none';
  subMenuBtn.setAttribute('aria-hidden', String(!show));
}

/* ---------- Render forms grid ---------- */
function renderGrid(system){
  formsGrid.innerHTML = '';
  const arr = DATA[system] || [];
  if (!arr.length) {
    formsGrid.innerHTML = '<div style="grid-column:1/-1;color:var(--muted)">No forms available</div>';
    return;
  }
  arr.forEach(it => {
    const tile = document.createElement('article');
    tile.className = 'tile' + (system.includes('Automatic') ? ' auto' : '');
    tile.setAttribute('role','listitem');

    const auth = document.createElement('div'); auth.className = 'auth-number'; auth.textContent = it.id;
    const d = document.createElement('div'); d.className = 'auth-desc'; d.textContent = it.desc || '';
    const actions = document.createElement('div'); actions.className = 'tile-actions';
    const btn = document.createElement('button'); btn.className = 'btn-view'; btn.textContent = 'View';
    btn.addEventListener('click', ()=> openViewer(it));
    actions.appendChild(btn);

    tile.appendChild(auth); tile.appendChild(d); tile.appendChild(actions);
    formsGrid.appendChild(tile);
  });
}

/* ---------- Select system ---------- */
function selectSystem(system){
  currentSystem = system;
  renderGrid(system);

  // show forms, hide home tiles
  homePills.style.display = 'none';
  formsArea.style.display = 'block';

  // show subheader and sub actions
  showSubheader(true, system);
  showSubBack(true);
  showMenuButton(true);
  showHomeBackPill(false);

  // populate side menu note/title when opened later
  sideMenuTitle.textContent = (system ? `${system} ‚Äî Quick forms` : 'Quick forms');

  try { history.pushState({page:'list', system}, '', '?system=' + encodeURIComponent(system)); } catch (e) {}
}

/* ---------- Back to systems ---------- */
function goBackToSystems() {
  currentSystem = null;
  formsArea.style.display = 'none';
  homePills.style.display = 'block';
  showSubheader(false, '');
  showSubBack(false);
  showMenuButton(false);
  showHomeBackPill(true);
  closeSideMenu();
  try { history.pushState({page:'home'}, '', location.pathname); } catch(e){}
}

/* ---------- Viewer navigation ---------- */
function openViewer(item){
  const q = new URLSearchParams();
  q.set('file', item.file);
  q.set('id', item.id);
  q.set('system', currentSystem || '');
  window.location.href = 'viewer.html?' + q.toString();
}

/* ---------- Wire tile clicks ---------- */
[pillABS, pillATS].forEach(el => {
  if (!el) return;
  el.addEventListener('click', () => selectSystem(el.dataset.system));
  el.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); selectSystem(el.dataset.system); }
  });
});

/* ---------- home pill behaviour ---------- */
if (homeBackPill) {
  homeBackPill.addEventListener('click', () => {
    // navigate back to index or previous location; change if you want a different target
    window.location.href = 'index.html';
  });
}

/* ---------- subheader back ---------- */
if (subBackBtn) {
  subBackBtn.addEventListener('click', goBackToSystems);
  subBackBtn.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); goBackToSystems(); } });
}

/* ---------- side menu open/close & populate ---------- */
function openSideMenu(){
  if (!sideMenu || !overlay) return;
  populateSideMenu();
  sideMenu.classList.add('open');
  sideMenu.setAttribute('aria-hidden','false');
  overlay.classList.add('show');
  overlay.setAttribute('aria-hidden','false');
  // focus first menu item
  setTimeout(()=> {
  const closeBtn = sideMenu.querySelector('.close-btn') || document.getElementById('sideCloseBtn');
  if (closeBtn) closeBtn.focus();
}, 80);
}
function closeSideMenu(){
  if (!sideMenu || !overlay) return;
  sideMenu.classList.remove('open');
  sideMenu.setAttribute('aria-hidden','true');
  overlay.classList.remove('show');
  overlay.setAttribute('aria-hidden','true');
  // return focus to subMenuBtn
  setTimeout(()=> { if (subMenuBtn) subMenuBtn.focus(); }, 40);
}

if (subMenuBtn) subMenuBtn.addEventListener('click', openSideMenu);
if (sideCloseBtn) sideCloseBtn.addEventListener('click', closeSideMenu);
if (overlay) overlay.addEventListener('click', closeSideMenu);

function populateSideMenu() {
  sideMenuList.innerHTML = '';

  // Show main heading
  sideMenuTitle.textContent = 'Operating Forms';

  // Check for selected system
  if (!currentSystem || !DATA[currentSystem]) {
    sideMenuNote.style.display = 'block';
    sideMenuNote.textContent = 'No forms available. Select a system first.';
    return;
  }

  // Show system name just below heading
  sideMenuNote.style.display = 'block';
  sideMenuNote.style.fontWeight = '700';
  sideMenuNote.style.fontSize = '0.95rem';
  sideMenuNote.style.color = '#333';
  sideMenuNote.textContent = currentSystem;

  const arr = DATA[currentSystem];

  // Create button list (form numbers only)
  arr.forEach(it => {
    const liBtn = document.createElement('button');
    liBtn.type = 'button';
    liBtn.textContent = it.id; // only number
    liBtn.style.textAlign = 'center';
    liBtn.style.fontWeight = '800';
    liBtn.style.fontSize = '1rem';
    liBtn.style.padding = '12px';
    liBtn.style.borderRadius = '10px';
    liBtn.style.border = '1px solid rgba(0,0,0,0.06)';
    liBtn.style.background = '#fff';
    liBtn.style.cursor = 'pointer';
    liBtn.style.transition = 'transform 0.18s ease, box-shadow 0.18s ease';

    liBtn.addEventListener('mouseenter', () => {
      liBtn.style.transform = 'translateY(-2px)';
      liBtn.style.boxShadow = '0 10px 20px rgba(25,118,210,0.08)';
    });
    liBtn.addEventListener('mouseleave', () => {
      liBtn.style.transform = 'translateY(0)';
      liBtn.style.boxShadow = 'none';
    });

    liBtn.addEventListener('click', () => {
      closeSideMenu();
      openViewer(it);
    });

    sideMenuList.appendChild(liBtn);
  });
}
/* ---------- popstate / deep link ---------- */
(function initFromQuery(){
  const q = new URLSearchParams(location.search);
  const sys = q.get('system');
  if (sys && DATA[sys]) {
    setTimeout(()=> selectSystem(sys), 40);
  }
})();
window.addEventListener('popstate', (evt) => {
  const s = (evt && evt.state) || {};
  if (s && s.system && DATA[s.system]) selectSystem(s.system);
  else goBackToSystems();
});

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', () => {
  // initial state: home
  showHomeBackPill(true);
  showSubheader(false, '');
  showSubBack(false);
  showMenuButton(false);
});
/*
  Fix: Keep main header fixed and ensure subheader sits below it.
  Usage: drop this after your existing scripts.
*/
(function(){
  // Identify your existing header element (the <header> in your HTML)
  const headerEl = document.querySelector('header');
  if (!headerEl) return;

  // Give it an explicit id/class so CSS above applies
  headerEl.id = headerEl.id || 'mainHeaderFixed';

  // Insert spacer immediately after header (to avoid content jump)
  let spacer = document.getElementById('mainHeaderSpacer');
  if (!spacer) {
    spacer = document.createElement('div');
    spacer.id = 'mainHeaderSpacer';
    headerEl.parentNode.insertBefore(spacer, headerEl.nextSibling);
  }

  // Subheader reference (you already have one)
  const subheader = document.getElementById('systemSubheader');

  // Helper: set heights precisely using computed style
  function updateHeights(){
    // compute header height (include margins if any)
    const rect = headerEl.getBoundingClientRect();
    const headerH = Math.ceil(rect.height || parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 88);

    // set CSS variable to be used by subheader top and other places
    document.documentElement.style.setProperty('--header-height', headerH + 'px');

    // set spacer height (px) so page content doesn't jump
    spacer.style.height = headerH + 'px';

    // If subheader is fixed, ensure its top remains header height
    if (subheader && subheader.classList.contains('fixed-subheader')) {
      subheader.style.top = headerH + 'px';
    }
  }

  // Make subheader use fixed positioning if formsArea visible (you may already have similar logic)
  function enableSubheaderFixed(){
    if (!subheader) return;
    // ensure the class present
    subheader.classList.add('fixed-subheader');
    // set top to header height (recomputed)
    const headerH = Math.ceil(headerEl.getBoundingClientRect().height || parseInt(getComputedStyle(document.documentElement).getPropertyValue('--header-height')) || 88);
    subheader.style.top = headerH + 'px';
  }
  function disableSubheaderFixed(){
    if (!subheader) return;
    subheader.classList.remove('fixed-subheader');
    subheader.style.top = '';
  }

  // Wrap existing navigation functions if available so we can enable/disable subheader appropriately
  if (typeof window.selectSystem === 'function') {
    const origSelect = window.selectSystem;
    window.selectSystem = function(system){
      const r = origSelect.apply(this, arguments);
      // after the UI switches, ensure header/subheader are updated
      setTimeout(()=> { updateHeights(); enableSubheaderFixed(); }, 40);
      return r;
    };
  }

  if (typeof window.goBackToSystems === 'function') {
    const origBack = window.goBackToSystems;
    window.goBackToSystems = function(){
      const r = origBack.apply(this, arguments);
      setTimeout(()=> { updateHeights(); disableSubheaderFixed(); }, 40);
      return r;
    };
  }

  // On initial load compute heights and enable/disable appropriately
  document.addEventListener('DOMContentLoaded', () => {
    updateHeights();
    // If formsArea visible on load, keep subheader fixed; else not
    const formsArea = document.getElementById('formsArea');
    if (formsArea && window.getComputedStyle(formsArea).display !== 'none') {
      enableSubheaderFixed();
    } else {
      disableSubheaderFixed();
    }
  });

  // Recompute on resize and also on font load (to be safe)
  window.addEventListener('resize', updateHeights, { passive:true });
  window.addEventListener('load', updateHeights);

  // Observe header size changes (if any dynamic content alters header height)
  const ro = new ResizeObserver(updateHeights);
  ro.observe(headerEl);
  if (subheader) ro.observe(subheader);

})();

(function(){
  const sideMenu = document.getElementById('sideMenu');
  const overlay = document.getElementById('overlay');
  const headerEl = document.querySelector('header');
  const subheader = document.getElementById('systemSubheader');
  const sideCloseBtn = document.getElementById('sideCloseBtn');

  if (!sideMenu || !overlay) return;

  /* --- Clean icon --- */
  if (sideCloseBtn) sideCloseBtn.textContent = '';

  /* --- Add Home button if missing --- */
  if (!document.getElementById('sideHomeBtn')) {
    const homeBtn = document.createElement('button');
    homeBtn.id = 'sideHomeBtn';
    homeBtn.innerHTML = 'üè†&nbsp;<span>Home</span>';
    homeBtn.addEventListener('click', () => {
      if (typeof closeSideMenu === 'function') closeSideMenu();
      else {
        sideMenu.classList.remove('open');
        overlay.classList.remove('show');
      }
      setTimeout(() => location.href = 'index.html', 150);
    });
    sideMenu.insertBefore(homeBtn, sideMenu.firstChild);
  }

  /* --- Adjust menu top position below headers --- */
  function adjustSideMenuPosition(){
    const headerH = headerEl ? Math.ceil(headerEl.getBoundingClientRect().height) : 88;
    const subH = (subheader && getComputedStyle(subheader).display !== 'none')
      ? Math.ceil(subheader.getBoundingClientRect().height || 64)
      : 0;
    const topPx = headerH + subH + 8;
    sideMenu.style.top = topPx + 'px';
    sideMenu.style.height = `calc(100vh - ${topPx + 12}px)`;
  }

  window.addEventListener('resize', adjustSideMenuPosition, { passive:true });
  if ('ResizeObserver' in window) {
    const ro = new ResizeObserver(adjustSideMenuPosition);
    if (headerEl) ro.observe(headerEl);
    if (subheader) ro.observe(subheader);
  }

  if (sideMenu.classList.contains('open')) adjustSideMenuPosition();
})();
</script>
</body>
</html>
