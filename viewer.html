<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Viewer — Operating Forms</title>
  <style>
    :root{
      --accent-blue:#1976d2;
      --accent-green:#388e3c;
      --bg:#f7f9fb;
      --muted:#6b7280;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0; padding:0; height:100%;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      background:var(--bg); color:#0b1220;
      /* allow normal page scrolling so embedded PDFs can receive wheel events */
      overflow:auto;
    }

    header{
      position:sticky; top:0; z-index:100;
      background:linear-gradient(90deg,var(--accent-blue),var(--accent-green));
      color:#fff; display:flex; align-items:center; justify-content:center;
      padding:14px; box-shadow:0 6px 18px rgba(0,0,0,0.15);
    }
    h1{
      margin:0; font-size:clamp(1.3rem,4vw,1.9rem);
      font-weight:800; letter-spacing:.5px; text-align:center; padding:0 60px;
    }
    .btn-back{
      position:absolute; left:16px; top:50%; transform:translateY(-50%);
      background:rgba(255,255,255,0.12); border:0; color:#fff;
      width:44px; height:44px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.25);
      transition:transform .2s ease;
    }
    .btn-back:hover{ transform:translateY(-50%) scale(1.05); }
    .btn-back svg{ width:22px; height:22px; stroke:#fff; fill:none; stroke-width:2.5; }

    /* viewer layout */
    main{
      min-height: calc(100vh - 72px);
      display:flex; flex-direction:column; align-items:center;
      padding:10px 12px 24px;
      -webkit-overflow-scrolling:touch;
    }

    .viewer-container{
      width:100%;
      max-width:980px;
      height: calc(100vh - 100px); /* fill space below header */
      display:flex;
      flex-direction:column;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 8px 24px rgba(12,18,36,0.06);
      overflow: hidden;
    }

    .file-info{
      padding:10px 14px;
      border-bottom:1px solid #f1f5f9;
      color:var(--muted);
      font-size:0.95rem;
    }

    /* this area is scrollable — allows mouse wheel, trackpad & touch to scroll the document */
    #viewerBody{
      flex:1;
      overflow:auto;        /* <-- important */
      -webkit-overflow-scrolling: touch;
      background: #ffffff;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    /* keep iframe full width and minimum height to allow built-in PDF viewers to show scrollbars */
    iframe{
      width:100%;
      min-height:100%;
      border:0;
      display:block;
      background:#fff;
    }

    img {
      max-width:100%;
      height:auto;
      display:block;
      margin:auto;
    }

    .controls{
      display:flex; gap:10px; align-items:center; justify-content:center;
      padding:12px; border-top:1px solid #f1f5f9;
      background: #fff;
    }
    .download-btn{
      padding:10px 18px; border-radius:999px; border:0;
      background:linear-gradient(90deg,var(--accent-blue),#0f63b8);
      color:#fff; font-weight:700; cursor:pointer;
      box-shadow:0 8px 20px rgba(15,74,163,0.12);
    }
    .open-btn{
      padding:10px 14px; border-radius:999px; border:1px solid rgba(0,0,0,0.06);
      background:#fff; color:#111; font-weight:700; cursor:pointer;
    }

    @media(max-width:640px){
      h1{ font-size:1.3rem }
      .viewer-container{ height:calc(100vh - 90px) }
      .download-btn, .open-btn { padding:10px 14px; font-size:0.95rem; }
    }
  </style>
</head>
<body>
  <header>
    <button class="btn-back" id="goBack" aria-label="Back">
      <svg viewBox="0 0 24 24"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    </button>
    <h1 id="viewerTitle">Document Viewer</h1>
  </header>

  <main>
    <div class="viewer-container" role="main">
      <div class="file-info" id="fileInfo">Loading document...</div>

      <div id="viewerBody"></div>

      <div class="controls" aria-hidden="false">
        <button id="downloadBtn" class="download-btn">Download</button>
        <button id="openBtn" class="open-btn">Open in new tab</button>
      </div>
    </div>
  </main>

  <script>
    // read params
    const params = new URLSearchParams(location.search);
    const file = params.get('file');
    const id = params.get('id') || 'Document';
    const system = params.get('system') || '';

    const titleEl = document.getElementById('viewerTitle');
    const fileInfo = document.getElementById('fileInfo');
    const viewerBody = document.getElementById('viewerBody');
    const downloadBtn = document.getElementById('downloadBtn');
    const openBtn = document.getElementById('openBtn');
    const goBack = document.getElementById('goBack');

    titleEl.textContent = id;
    fileInfo.textContent = system ? `${system}` : '';

    async function fetchAndDownload(url, filename){
      try {
        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Fetch failed: ' + res.status);
        const blob = await res.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl;
        a.download = filename || '';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(blobUrl), 2000);
        return true;
      } catch (err) {
        console.warn('fetchAndDownload failed', err);
        return false;
      }
    }

    (function render(){
      if (!file) {
        viewerBody.innerHTML = '<div style="padding:18px;text-align:center;color:#666">No file specified.</div>';
        downloadBtn.style.display = 'none';
        openBtn.style.display = 'none';
        return;
      }

      const ext = (file.split('.').pop() || '').toLowerCase();
      fileInfo.textContent = system ? `${system} • ${ext.toUpperCase()}` : `${ext.toUpperCase()}`;

      viewerBody.innerHTML = '';

      if (ext === 'pdf') {
        const iframe = document.createElement('iframe');
        iframe.src = file;
        iframe.setAttribute('aria-label', id);
        // make focusable so wheel/keyboard inputs reach it more reliably
        iframe.tabIndex = 0;
        iframe.style.minHeight = '100%';
        iframe.style.height = '100%';
        viewerBody.appendChild(iframe);

        // try to focus iframe on load (best-effort; cross-origin may prevent access)
        iframe.addEventListener('load', () => {
          try { iframe.focus(); } catch (e) { /* ignore cross-origin */ }
        });

      } else if (['jpg','jpeg','png','webp','gif','svg'].includes(ext)) {
        const imgWrap = document.createElement('div');
        imgWrap.style.display = 'flex';
        imgWrap.style.alignItems = 'center';
        imgWrap.style.justifyContent = 'center';
        imgWrap.style.padding = '20px';
        const img = document.createElement('img');
        img.src = file;
        img.alt = id;
        img.loading = 'lazy';
        img.style.maxWidth = '100%';
        img.style.height = 'auto';
        imgWrap.appendChild(img);
        viewerBody.appendChild(imgWrap);

      } else {
        viewerBody.innerHTML = '<div style="padding:18px;text-align:center;color:#666">Unsupported file type.</div>';
      }

      // hooks for download/open
      downloadBtn.onclick = async () => {
        const extLocal = ext || 'bin';
        const suggested = (id || 'document').replace(/[\/\\:?<>|*"']/g,'_') + '.' + extLocal;
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'Downloading...';
        const ok = await fetchAndDownload(file, suggested);
        if (!ok) {
          alert('Direct download blocked by CORS. The file will open in a new tab — you can save from there.');
          window.open(file, '_blank');
        }
        downloadBtn.disabled = false;
        downloadBtn.textContent = 'Download';
      };

      openBtn.onclick = () => {
        window.open(file, '_blank');
      };
    })();

    // back behaviour: prefer history.back() else go to operating-form.html
    goBack.addEventListener('click', () => {
      if (history.length > 1) history.back();
      else window.location.href = 'operating-form.html';
    });

    // When user scrolls with wheel over the viewer area, ensure viewerBody scrolls (desktop)
    // This is defensive: wheel events should naturally scroll the viewerBody; this ensures focus.
    viewerBody.addEventListener('wheel', (e) => {
      // nothing special required — but keep event default to allow native scrolling
    }, { passive: true });
  </script>
</body>
</html>
