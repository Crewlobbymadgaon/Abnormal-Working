<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Viewer — Operating Forms</title>
  <style>
    :root{
      --accent-blue:#1976d2;
      --accent-green:#388e3c;
      --bg:#f7f9fb;
      --muted:#6b7280;
    }
    *,*::before,*::after{box-sizing:border-box}
    html,body{
      margin:0; padding:0; height:100%; background:var(--bg); color:#0b1220;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    }

    header{
      position:sticky; top:0; z-index:100;
      background:linear-gradient(90deg,var(--accent-blue),var(--accent-green));
      color:#fff; display:flex; align-items:center; justify-content:center;
      padding:14px 12px; box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }
    h1{
      margin:0; font-size:clamp(1.2rem,3.5vw,1.9rem);
      font-weight:800; text-align:center; padding:0 56px;
    }
    .btn-back{
      position:absolute; left:12px; top:50%; transform:translateY(-50%);
      background:rgba(255,255,255,0.12); border:0; color:#fff;
      width:44px; height:44px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.22);
    }
    .btn-back svg{ width:20px; height:20px; stroke:#fff; fill:none; stroke-width:2.4; }

    main{ min-height: calc(100vh - 72px); display:flex; flex-direction:column; align-items:center; padding:12px; -webkit-overflow-scrolling:touch; }

    .viewer-wrap{
      width:100%; max-width:980px; height: calc(100vh - 110px);
      background:#fff; border-radius:10px; box-shadow:0 8px 24px rgba(12,18,36,0.06);
      display:flex; flex-direction:column; overflow:hidden;
    }

    .file-info{
      padding:10px 14px; border-bottom:1px solid #f1f5f9; color:var(--muted); font-size:0.95rem;
    }

    /* SCROLLABLE area that contains the iframe/image */
    #viewerBody{
      flex:1; overflow:auto; -webkit-overflow-scrolling:touch; display:flex; align-items:stretch; justify-content:center;
      background:#ffffff;
    }

    /* iframe fills available area; min-height ensures PDF viewers inside show scrollbars */
    #viewerBody iframe{
      width:100%; min-height:100%; border:0; display:block;
    }

    #viewerBody img{ max-width:100%; height:auto; display:block; margin:auto; }

    .controls{ display:flex; gap:12px; align-items:center; justify-content:center; padding:12px; border-top:1px solid #f1f5f9; background:#fff; }
    .download-btn{
      padding:10px 18px; border-radius:999px; border:0; background:linear-gradient(90deg,var(--accent-blue),#0f63b8); color:#fff; font-weight:700; cursor:pointer;
      box-shadow:0 8px 20px rgba(15,74,163,0.12);
    }

    @media(max-width:640px){
      .viewer-wrap{ height: calc(100vh - 98px); border-radius:8px; }
      h1{ font-size:1.25rem; padding:0 48px; }
    }
  </style>
</head>
<body>
  <header>
    <button id="goBack" class="btn-back" aria-label="Back">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M19 12H5M12 5l-7 7 7 7"/></svg>
    </button>
    <h1 id="title">Document Viewer</h1>
  </header>

  <main>
    <div class="viewer-wrap" role="main" aria-label="Document viewer">
      <div class="file-info" id="fileInfo">Loading…</div>

      <div id="viewerBody" aria-live="polite"></div>

      <div class="controls">
        <button id="downloadBtn" class="download-btn">Download</button>
      </div>
    </div>
  </main>

  <script>
    // Read query params: ?file=...&id=...&system=...
    const ps = new URLSearchParams(location.search);
    const file = ps.get('file');
    const id = ps.get('id') || 'Document';
    const system = ps.get('system') || '';

    const titleEl = document.getElementById('title');
    const fileInfo = document.getElementById('fileInfo');
    const viewerBody = document.getElementById('viewerBody');
    const downloadBtn = document.getElementById('downloadBtn');
    const goBack = document.getElementById('goBack');

    titleEl.textContent = id;
    fileInfo.textContent = system ? system : '';

    // robust download (fetch -> blob) with fallback
    async function fetchAndDownload(url, filename){
      try {
        const res = await fetch(url, { credentials: 'same-origin' });
        if (!res.ok) throw new Error('Fetch failed: ' + res.status);
        const blob = await res.blob();
        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = blobUrl; a.download = filename || '';
        document.body.appendChild(a); a.click(); a.remove();
        setTimeout(()=> URL.revokeObjectURL(blobUrl), 2000);
        return true;
      } catch (err) {
        console.warn('Download via fetch failed:', err);
        return false;
      }
    }

    // Render document inside page (iframe for pdf, img for images)
    (function render(){
      if (!file){
        viewerBody.innerHTML = '<div style="padding:18px;text-align:center;color:#666">No file provided.</div>';
        downloadBtn.style.display = 'none';
        return;
      }

      const ext = (file.split('.').pop() || '').toLowerCase();
      fileInfo.textContent = system ? `${system} • ${ext.toUpperCase()}` : `${ext.toUpperCase()}`;

      viewerBody.innerHTML = ''; // clear

      if (ext === 'pdf'){
        const iframe = document.createElement('iframe');
        iframe.src = file;
        iframe.setAttribute('aria-label', id);
        iframe.tabIndex = 0;                // allow focusing
        iframe.style.minHeight = '100%';
        iframe.style.height = '100%';
        viewerBody.appendChild(iframe);

        // Focus the iframe when user moves pointer over the viewer (helps wheel/trackpad)
        viewerBody.addEventListener('pointerenter', () => {
          try { iframe.focus(); } catch(e){ /* cross-origin may block focus; ignore */ }
        }, { once: false, passive: true });

        // also focus on click/touch
        viewerBody.addEventListener('click', () => { try { iframe.focus(); } catch(e){} }, { passive: true });

      } else if (['jpg','jpeg','png','webp','gif','svg'].includes(ext)){
        const img = document.createElement('img');
        img.src = file;
        img.alt = id;
        img.loading = 'lazy';
        viewerBody.appendChild(img);
      } else {
        viewerBody.innerHTML = '<div style="padding:18px;text-align:center;color:#666">Unsupported file type.</div>';
        downloadBtn.style.display = 'none';
      }
    })();

    // Download button
    downloadBtn.addEventListener('click', async () => {
      const ext = (file && file.split('.').pop()) || 'bin';
      const safeName = (id || 'document').replace(/[\/\\:?<>|*"']/g,'_') + '.' + ext;
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'Downloading...';
      const ok = await fetchAndDownload(file, safeName);
      if (!ok) {
        // If fetch fails (CORS or other), open file in new tab as fallback — user can save from there.
        alert('Direct download blocked (CORS). The file will open in a new tab — you can save it there.');
        window.open(file, '_blank');
      }
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'Download';
    });

    // Back behavior: if there's history navigate back else go to operating forms page
    goBack.addEventListener('click', () => {
      if (history.length > 1) history.back();
      else location.href = 'operating-form.html';
    });

    // Make the viewerBody scrollable on desktop & mobile. Nothing special required —
    // but ensure it receives pointer/touch/wheel events (we don't block them).
    // (We left the default behavior so users can mousewheel/trackpad/drag or touch-scroll.)
  </script>
</body>
</html>
