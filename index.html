,<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="apple-touch-icon" href="abnormal-working-192.png">
<meta name="theme-color" content="#1976d2">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Abnormal Working and Operating Forms</title>

<style>
:root{
  --header-height: 88px;
  --accent-blue: #1976d2;
  --accent-green: #388e3c;
  --card-font-min: 15px;
  --card-font-mid: 1.6vw;
  --card-font-max: 18px;
}

/* Page shell */
html,body{ height:100%; margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background:#f9f9f9; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; scroll-behavior:smooth; color:#222; }

/* utility: no-scroll toggle */
.no-scroll { overflow: hidden !important; }

/* skip link */
.skip-link {
  position: absolute;
  left: -9999px;
  top: auto;
  width: 1px;
  height: 1px;
  overflow: hidden;
}
.skip-link:focus {
  left: 10px;
  top: 10px;
  width: auto;
  height: auto;
  padding: 8px 12px;
  background: #000;
  color: #fff;
  border-radius: 4px;
  z-index: 9999;
}

/* --- Uniform Header (Perfectly Centered on Both Pages) --- */
header,
.category-mode header {
  height: var(--header-height);
  min-height: var(--header-height);
  background: linear-gradient(90deg, var(--accent-blue), var(--accent-green));
  padding: 0 20px;
  position: sticky;
  top: 0;
  z-index: 110;
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  display: flex;
  align-items: center;    /* Vertically center everything */
  justify-content: center;/* Horizontally center */
  box-sizing: border-box;
  overflow: hidden;
}

/* --- Main Heading Text (Aligned & Scaled Identically) --- */
#mainHeading,
.category-mode #mainHeading {
  color: #fff;
  margin: 0;
  font-weight: 800;
  letter-spacing: 1px;
  text-align: center;
  line-height: 1.1;
  display: flex;
  flex-direction: column; /* stacked title lines (for multi-line title) */
  align-items: center;
  justify-content: center;
  gap: 2px;
  padding: 0;
  font-size: clamp(1.5rem, 3.5vw, 2.0rem);
  height: 100%;           /* ensure vertical centering inside header */
  box-sizing: border-box;
}

#mainHeading span {
  display: block;
  width: 100%;
}

#mainHeading span:nth-child(2) {
  font-size: 1em;
  opacity: 0.9;
}




/* Make the main heading single-line on tablet/desktop */
@media (min-width: 720px) {
  header { height: var(--header-height); min-height: var(--header-height); } /* keep header height stable */

  #mainHeading {
    flex-direction: row;        /* put spans in one row */
    gap: 10px;                  /* small gap between words */
    white-space: nowrap;        /* prevent wrapping */
    align-items: center;        /* vertical align */
    justify-content: center;    /* horizontal centering */
    font-size: clamp(1rem, 1.6vw, 1.25rem); /* slightly smaller on large screens so it fits */
    line-height: 1;             /* tighten line-height for single-line layout */
    padding: 0 12px;            /* small horizontal padding to avoid clipping */
  }

  #mainHeading span {
    display: inline-block;      /* keep each span inline so the whole title stays on one line */
    vertical-align: middle;
    padding: 0 6px;             /* breathing room between title parts */
  }

  /* keep the ampersand slightly less prominent */
  #mainHeading span:nth-child(2) {
    font-size: 0.95em;
    opacity: 0.95;
  }
}


/* small helper */
.nowrap { white-space: nowrap; }

/* App layout */
.app{display:flex;flex-direction:column;height:calc(100% - var(--header-height));}
#selectionPage{padding:18px;overflow-y:auto;flex:1 1 auto;}
#systemPage{display:none;flex-direction:column;height:100%;}
.subheader {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
  padding: 12px 20px;
  border-bottom: 2px solid #ddd;
  position: sticky;
  top: var(--header-height);
  z-index: 105;
  box-sizing: border-box;
  gap: 10px;
}
#systemTitle{font-size:1.2rem;color:#333;margin:0;text-align:center;font-weight:700;}
#parentHeading { background:#fff; border-bottom:1px solid #e6eef6; position:sticky; z-index:104; display:none; padding:8px 20px; top:calc(var(--header-height)); }
#parentHeadingText { font-size:1.1rem; font-weight:700; color:#000; text-align:center; }

#systemMain{ flex:1 1 auto; overflow-y:auto; padding:20px; -webkit-overflow-scrolling: touch; box-sizing:border-box; }
/* --- Home Screen Blocks (Improved, White & Larger Text) --- */
.block-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 30px;
  flex-wrap: wrap;
  margin-top: 50px;
  padding: 0 20px;
}

/* Main tiles */
.block {
  flex: 1 1 260px;
  max-width: 340px;
  min-height: 160px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 20px;
  padding: 20px;
  box-sizing: border-box;
  cursor: pointer;
  text-align: center;
  font-weight: 900;
  color: #fff;  /* White text */
  font-size: clamp(24px, 4vw, 36px); /* Bigger, responsive */
  letter-spacing: 0.5px;
  text-transform: none;
  text-shadow: 0 3px 12px rgba(0,0,0,0.35);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
  user-select: none;
}

/* Gradient backgrounds */
.block.abs {
  background: linear-gradient(145deg, #1976d2, #42a5f5);
}
.block.auto {
  background: linear-gradient(145deg, #2e7d32, #66bb6a);
}
/* New: Miscellaneous tile styling */
.block.misc {
  background: linear-gradient(145deg, #6a1b9a, #8e24aa);
}

/* Hover & focus effects */
.block:hover, .block:focus {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 20px 40px rgba(0,0,0,0.25);
  outline: none;
}

/* Tap effect */
.block:active {
  transform: translateY(2px) scale(0.97);
}

/* Subtle highlight overlay */
.block::before {
  content: "";
  position: absolute;
  left: -20%;
  top: -40%;
  width: 140%;
  height: 60%;
  transform: rotate(-18deg);
  background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0));
  pointer-events: none;
  mix-blend-mode: overlay;
}

/* Mobile adjustments */
@media (max-width: 720px) {
  .block {
    min-height: 140px;
    font-size: clamp(20px, 5vw, 28px);
  }
}
@media (max-width: 420px) {
  .block {
    min-height: 120px;
    font-size: clamp(18px, 6vw, 24px);
  }
}



/* Grid layout */
.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 20px;
  margin: 20px auto;
  max-width: 980px;
  align-content: start;
}

.grid-item {
  background: #fff;
  border-radius: 12px;
  padding: 18px 16px;
  margin: 6px;
  font-size: 1.15rem;
  font-weight: 700;
  text-align: center;
  line-height: 1.3;
  user-select: none;
  cursor: pointer;
  box-shadow:
    0 2px 4px rgba(0,0,0,0.06),
    0 8px 16px rgba(0,0,0,0.08);
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

/* Hover effect */
.grid-item:hover {
  transform: translateY(-6px) scale(1.02);
  background: #ffffff;
  box-shadow:
    0 8px 16px rgba(0, 0, 0, 0.12),
    0 20px 40px rgba(0, 0, 0, 0.14);
}

/* Active (click/tap) effect */
.grid-item:active {
  transform: translateY(-2px) scale(0.98);
  box-shadow:
    0 4px 8px rgba(0,0,0,0.15),
    0 10px 20px rgba(0,0,0,0.18);
}

/* Remove default focus ring */
.grid-item:focus {
  outline: none;
}
/* Cards: uniform, centered, readable */
.card{ display:none; max-width:900px; margin:20px auto; background:white; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.14); overflow:hidden; }

/* universal box-sizing */
html { box-sizing: border-box; }
*, *:before, *:after { box-sizing: inherit; }

/* Authority card (base) */
#authorityCard {
  display: none;
  width: 100%;
  max-width: 920px;
  margin: 18px auto;
  background: #fff;
  border-radius: 1px;
  box-shadow:
    0 6px 12px rgba(0,0,0,0.08),
    0 18px 36px rgba(0,0,0,0.12);
  overflow: hidden;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: stretch;
  transition: transform .18s ease, box-shadow .18s ease;
}

/* slim accent strip (system color) */
#authorityCard::before {
  content: "";
  position: absolute;
  inset: 0 auto auto 0;
  height: 6px;
  width: 100%;
  display: block;
}
#authorityCard.abs::before { background: #1976d2; }
#authorityCard.auto::before { background: #388e3c; }
#authorityCard.misc::before { background: #8e24aa; } /* purple accent for misc */

#authorityCard .sub-heading {
  position: sticky;
  top: 0;
  z-index: 6;
  background: rgba(224,247,250,0.88);
  backdrop-filter: blur(3px);
  padding: 8px 10px;
  margin: 0;
  font-family: serif;
  font-size: 1rem;
  font-weight: 700;
  text-align: center;
  color: #111;
  border-bottom: 1px solid rgba(0,0,0,0.04);
}

/* === Enforce uniform horizontal length for all card boxes === */
#authorityCard .card-body {
  padding: 8px 10px !important;
  gap: 8px !important;
  font-size: 0.95rem;
  line-height: 1.22;
}

#authorityCard .card-box,
.card-box {
  display: block !important;
  box-sizing: border-box !important;
  width: 100% !important;
  max-width: 760px !important;
  margin: 12px auto !important;
  padding: 8px 10px !important;
  border-radius: 12px !important;
  align-self: stretch !important;
  overflow: hidden;
  word-break: break-word;
}

#authorityCard .card-box .card-box,
.card-box .card-box {
  width: 100% !important;
  max-width: 100% !important;
  margin: 8px 0 !important;
}

#authorityCard .card-box p,
#authorityCard .card-box .card-line {
  display: block !important;
  width: 100% !important;
  box-sizing: border-box !important;
  margin: 6px 0 !important;
  text-align: center !important;
}

/* Exception: left-aligned .card-html.left as bulleted paragraph style */
#authorityCard .card-html.left,
#authorityCard .card-html.left ul,
#authorityCard .card-html.left ol {
  text-align: left !important;
  padding-left: 32px !important;
  margin: 10px 0 !important;
}

#authorityCard .card-html.left ul {
  list-style-type: disc !important;
}

#authorityCard .card-html.left ol {
  list-style-type: decimal !important;
}

#authorityCard .card-html.left li {
  margin: 8px 0 !important;
  line-height: 1.35;
  text-align: left !important;
}

/* small helper classes */
.card-or {
  font-weight: 700;
  margin: 6px 0;
  font-size: clamp(13px, 1.2vw, 15px);
  color: #334155;
  text-align: center;
  line-height: 1.2;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.card-box {
  border: 3px solid #ddd;
  border-radius: 12px;
  padding: 14px 18px;
  margin: 12px 0;
  background: #fff;
  box-shadow: 0 3px 8px rgba(0,0,0,0.12);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card-box:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 12px rgba(0,0,0,0.18);
}

/* Buttons - use inline SVGs for icons (no FontAwesome) */
.back-btn, .menu-btn { position:absolute; top:50%; transform:translateY(-50%); width:40px; height:40px; border-radius:50%; border:none; color:#fff; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 12px rgba(0,0,0,0.25); transition: transform .18s ease, box-shadow .18s ease; }
.back-btn { left:10px; background:var(--accent-blue); display:none; } .menu-btn { right:10px; background:var(--accent-green); }

.back-btn svg, .menu-btn svg { width:20px; height:20px; fill: #fff; }
.back-btn:hover, .menu-btn:hover { transform:translateY(-50%) scale(1.05); box-shadow:0 6px 18px rgba(0,0,0,0.30); }

@media (max-width:720px){
  #mainHeading { font-size: 1rem; padding:8px 36px; }
  .card-box { padding:12px; }
  #authorityCard .card-body { padding:18px 16px; }
  .grid { gap:14px; margin:12px; }
  .grid-item { padding:12px; font-size:1rem; }
  .block{ height:120px; font-size:1rem; }

  :root { --card-font-min: 16px; --card-font-mid: 2.4vw; --card-font-max: 20px; }

  .card-box {
    max-width: 92% !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }

  .card-box .card-box,
  #authorityCard .card-box .card-box {
    max-width: 100% !important;
  }
}

@media (max-width:420px){
  #mainHeading { font-size: 1.02rem; padding:8px 24px; }
  #authorityCard .card-body { padding:16px 12px; }
  .card-box { padding:10px; margin:10px 0; }
  .block{ height:110px; }
  :root { --card-font-min: 16px; --card-font-mid: 3.0vw; --card-font-max: 20px; }

  .card-box {
    max-width: 96% !important;
    width: 100% !important;
  }
  .card-box .card-box,
  #authorityCard .card-box .card-box {
    max-width: 100% !important;
  }
}

/* overlay & side menu */
#overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.32); opacity: 0; pointer-events: none; transition: opacity .18s ease; z-index: 220; } #overlay.show { opacity:1; pointer-events:auto; }
#sideMenu { position:fixed; top:0; right:-320px; width:300px; height:100vh; background:#fff; box-shadow:-8px 0 24px rgba(0,0,0,0.18); transition:right .24s cubic-bezier(.2,.9,.2,1); z-index:230; padding:16px; box-sizing:border-box; overflow-y:auto; display:flex; flex-direction:column; gap:10px; }
#sideMenu.open { right:0; }
#menuList { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:6px; } #menuList button { display:block; width:100%; text-align:left; background:transparent; border:none; padding:10px 8px; font-size:0.98rem; border-radius:8px; cursor:pointer; }

/* reduced motion */
@media (prefers-reduced-motion: reduce) {
  * { transition: none !important; animation: none !important; scroll-behavior: auto !important; }
}

/* Bottom center mobile menu */
#bottomCenterMenu {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 12px;            /* little gap above safe area */
  display: flex;
  justify-content: center;
  pointer-events: auto;
  z-index: 9999;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
}

/* inner wrapper keeps content centered and compact */
#bottomCenterMenu .menu-inner {
  display: flex;
  gap: 10px;
  align-items: center;
  justify-content: center;
  padding: 6px;
  box-sizing: border-box;
  width: min(96%, 560px);   /* responsive width cap */
}

/* pill style for each menu item */
.menu-pill {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  border-radius: 999px;
  text-decoration: none;
  font-weight: 700;
  background: var(--accent-blue, #1976d2); /* uses your CSS var if present */
  color: #fff;
  box-shadow: 0 8px 20px rgba(25,118,210,0.12);
  border: 0;
  transition: transform .12s ease, box-shadow .12s ease;
}

/* optional ghost style if you want a secondary button */
.menu-pill.ghost {
  background: transparent;
  color: var(--accent-blue, #1976d2);
  box-shadow: 0 0 0 1px rgba(25,118,210,0.08);
}

/* touch / press states */
.menu-pill:active { transform: translateY(1px) scale(.995); }

/* Respect safe-area inset for iPhone notch */
@supports(padding: max(0px)) {
  #bottomCenterMenu { padding-bottom: env(safe-area-inset-bottom); }
  #bottomMenuSpacer { height: calc(76px + env(safe-area-inset-bottom)); }
}

/* Hide on wide desktop if you prefer (optional) */
@media (min-width: 900px){
  #bottomCenterMenu { bottom: 18px; }
}
/* === Home Tile Text (Slightly Reduced Size + Clean Glow) === */
.block,
.block *,
.block a,
.block:link,
.block:visited {
  text-decoration: none !important;
  color: #ffffff !important;                   /* Pure white */
  -webkit-text-fill-color: #ffffff !important;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  letter-spacing: 0.5px;
  font-size: clamp(22px, 4.2vw, 32px);         /* reduced from 26â€“42px */
  text-transform: none;
  text-align: center;
  text-shadow:
    0 3px 10px rgba(0,0,0,0.45),
    0 0 8px rgba(255,255,255,0.25),
    1px 2px 2px rgba(0,0,0,0.35);
  transition: text-shadow 0.3s ease, transform 0.3s ease;
}

/* Hover lift with brighter glow */
.block:hover {
  transform: translateY(-4px) scale(1.02);
  text-shadow:
    0 4px 14px rgba(0,0,0,0.55),
    0 0 14px rgba(255,255,255,0.3),
    1px 3px 3px rgba(0,0,0,0.45);
}

/* Make sure nested inline elements (spans, svg titles) also inherit white */
.block span,
.block p,
.block div {
  color: #ffffff !important;
  -webkit-text-fill-color: #ffffff !important;
}

/* --- Uniform round back button (same as menu button) --- */
.back-btn {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 40px;                     /* fixed width */
  height: 40px;                    /* same height = perfect circle */
  border-radius: 50%;              /* circular shape */
  background: var(--accent-blue);  /* blue fill to match theme */
  color: #fff;
  border: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: transform 0.18s ease, box-shadow 0.18s ease;
}

/* Hover/tap feedback */
.back-btn:hover {
  transform: translateY(-50%) scale(1.05);
  box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}
.back-btn:active {
  transform: translateY(-50%) scale(0.96);
}

/* Ensure SVG or text inside stays centered */
.back-btn svg,
.back-btn span {
  width: 18px;
  height: 18px;
  color: #fff;
  fill: currentColor;
}

/* Hide helper */
.back-btn.hidden {
  display: none !important;
}

/* ensure header menu button sits on right and matches visual style */
.menu-btn {
  right: 12px;
  left: auto;
}

/* ------------------------------
   Category (second-page) outline mode
   Apply when body has .category-mode (added by JS)
   ------------------------------ */

/* Keep header identical to home */
.category-mode header {
  min-height: var(--header-height);
  height: auto;
}
/* Match heading size exactly with home screen */
.category-mode #mainHeading {
  font-size: clamp(1.0rem, 3.0vw, 1.6rem);  /* same as home heading visual scale */
  line-height: 1.15;
  letter-spacing: 0.5px;
  padding: 10px 52px;
}
.category-mode .block {
  background: #ffffff !important;
  color: #0b0b0b !important;
  -webkit-text-fill-color: #0b0b0b !important;
  border-radius: 16px;
  border: 3px solid rgba(0,0,0,0.06);
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
  font-weight: 800;
  font-size: clamp(18px, 3.8vw, 26px);   /* increased font size */
  text-shadow: none;
  transition: transform .20s ease, box-shadow .20s ease, background .18s ease, border-color .18s ease;
  min-height: 120px;
  max-width: 420px;
  padding: 18px 22px;
  overflow: visible;
}

/* Colored outlines for each system (no fill) */
.category-mode .block.abs {
  border-color: #1976d2;                 /* blue outline */
  color: #0f4fa8 !important;             /* blue-ish label color */
  background: #fff !important;           /* ensure no gradient fill */
}
.category-mode .block.auto {
  border-color: #2e7d32;                 /* green outline */
  color: #1f6f2f !important;             /* green-ish label color */
  background: #fff !important;
}
.category-mode .block.misc {
  border-color: #8e24aa;                 /* purple outline */
  color: #5e1288 !important;
  background: #fff !important;
}

/* Hover: subtle tinted wash, keep mostly outline-only */
.category-mode .block.abs:hover,
.category-mode .block.abs:focus {
  background: rgba(25,118,210,0.04);     /* very light blue wash on hover */
  border-color: #1976d2;
  box-shadow: 0 10px 30px rgba(25,118,210,0.08);
  transform: translateY(-4px) scale(1.01);
}
.category-mode .block.auto:hover,
.category-mode .block.auto:focus {
  background: rgba(46,125,50,0.04);      /* very light green wash on hover */
  border-color: #2e7d32;
  box-shadow: 0 10px 30px rgba(56,142,60,0.08);
  transform: translateY(-4px) scale(1.01);
}
.category-mode .block.misc:hover,
.category-mode .block.misc:focus {
  background: rgba(142,36,170,0.04);      /* very light purple wash on hover */
  border-color: #8e24aa;
  box-shadow: 0 10px 30px rgba(142,36,170,0.06);
  transform: translateY(-4px) scale(1.01);
}

/* Ensure links inside the blocks inherit the outline text color */
.category-mode .block,
.category-mode .block a,
.category-mode .block * {
  color: inherit !important;
  -webkit-text-fill-color: inherit !important;
}

/* Reduce sheen overlay used on home tiles so outlines stay crisp */
.category-mode .block::before { opacity: 0.12; }

/* Force single-column on touch (coarse pointer) devices â€” safe for phones */
@media (pointer: coarse) {
  .block-container {
    flex-direction: column;
    align-items: center;
    gap: 14px;
    max-width: 720px;     /* optional: caps how wide tiles can grow on big phones */
    margin: 0 auto;
    padding: 0 12px;
  }
  .block {
    flex: 0 0 100%;
    max-width: 100%;
    width: 100%;
    box-sizing: border-box;
  }
}


</style>
</head>
<body>
<a class="skip-link" href="#selectionPage">Skip to content</a>
<header>
<h1 id="mainHeading">
  <span>ABNORMAL WORKING</span>
  <span>&amp;</span>
  <span class="nowrap">OPERATING FORMS</span>
</h1>
</header>

<div class="app" role="application">
  <div id="selectionPage" role="main" aria-label="System selection">
    <div class="block-container" role="list">
      <!-- primary - Abnormal Working: will show your two systems after selecting -->
      <div class="block abs" tabindex="0" role="button" aria-pressed="false"
           onclick="showCategory('Abnormal Working')"
           onkeydown="if(event.key==='Enter') showCategory('Abnormal Working')">
        Abnormal Working
      </div>

      <!-- primary - Operating Forms: native link (keeps browser navigation stable) -->
      <a class="block auto" href="./operating-form.html" role="link" aria-label="Open Operating Forms">
        Operating Forms
      </a>
    </div>

    <!-- Bottom center spacer & download button (mobile) -->
    <div id="bottomMenuSpacer" aria-hidden="true" style="height:92px;"></div>

    <nav id="bottomCenterMenu" class="bottom-menu" role="navigation" aria-label="Home menu">
      <div class="menu-inner" style="justify-content:center;">
        <button id="downloadOffline" class="menu-pill" type="button"
                style="padding:10px 18px;border:none;cursor:pointer;">
          ðŸ“¥ Download offline
        </button>
      </div>
    </nav>
  </div>

  <div id="systemPage" aria-hidden="true">
    <div class="subheader">
      <button class="back-btn" onclick="goBack()" aria-label="Go back" id="backBtn">
        <!-- inline svg long arrow -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M19 12H5M12 5l-7 7 7 7"
                stroke="currentColor"
                stroke-width="2.5"
                fill="none"
                stroke-linecap="round"
                stroke-linejoin="round"/>
        </svg>
      </button>

      <h2 id="systemTitle"></h2>

      <button class="menu-btn" onclick="openMenu()" aria-label="Open menu" id="menuBtn">
        <!-- inline svg menu -->
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z"></path>
        </svg>
      </button>
    </div>

    <div id="parentHeading"><div id="parentHeadingText"></div></div>

    <main id="systemMain" tabindex="0">
      <div id="circumstancesGrid" class="grid" aria-label="Circumstances list"></div>
      <div id="subMenuGrid" class="grid" aria-label="Submenu list" style="display:none;"></div>
      <div id="authorityCard" class="card uniform" role="dialog" aria-modal="true" aria-label="Authority details" style="display:none;"></div>
    </main>
  </div>
</div>

<!-- overlay & side menu -->
<div id="overlay" aria-hidden="true" onclick="closeMenu()"></div>
<aside id="sideMenu" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="home-row">
    <button id="menuHomeBtn" onclick="goHomeFromMenu()" aria-label="Go home">Home</button>
  </div>

  <div id="menuCurrentBlock">
    <div class="system-name" id="menuCurrentSystem">No system selected</div>
    <div class="system-note" id="menuSystemNote">Select a system from the main screen to see its subfolders here.</div>
  </div>

  <ul id="menuList" aria-label="System subfolders"></ul>
</aside>

<script>
/* ----------------------------
   Single-file PWA bootstrap (fixed)
   - creates manifest (Blob URL) safely (Unicode-safe base64)
   - creates service-worker (Blob URL) and registers it
   - precaches current pathname + operating-form.html
   ---------------------------- */

(function(){
  // Unicode-safe base64 helper
  function toBase64Unicode(str) {
    return btoa(encodeURIComponent(str).replace(/%([0-9-A-F]{2})/g, function(match, p1){
      return String.fromCharCode('0x' + p1);
    }));
  }

  const manifestIconSVG = `
<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512' viewBox='0 0 512 512'>
  <rect width='100%' height='100%' rx='64' fill='#1976d2'/>
  <g font-family='Arial, Helvetica, sans-serif' font-weight='700' fill='#fff'>
    <text x='50%' y='45%' dominant-baseline='middle' text-anchor='middle' font-size='48'>ABNORMAL</text>
    <text x='50%' y='65%' dominant-baseline='middle' text-anchor='middle' font-size='48'>WORKING</text>
  </g>
</svg>`;

  const manifestIconDataURI = 'data:image/svg+xml;base64,' + toBase64Unicode(manifestIconSVG);

  const manifest = {
    name: "Abnormal Working & Operating Forms",
    short_name: "AbnormalForms",
    description: "Authorities & Abnormal Working â€” offline reference",
    start_url: "./",
    display: "standalone",
    orientation: "portrait",
    background_color: "#ffffff",
    theme_color: "#1976d2",
    icons: [
      { src: manifestIconDataURI, sizes: "192x192", type: "image/svg+xml" },
      { src: manifestIconDataURI, sizes: "256x256", type: "image/svg+xml" },
      { src: manifestIconDataURI, sizes: "512x512", type: "image/svg+xml" }
    ]
  };

  // create manifest blob url and attach link
  try {
    const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link');
    link.rel = 'manifest';
    link.href = manifestURL;
    document.head.appendChild(link);
  } catch (e) {
    console.warn('Manifest blob creation failed', e);
  }

  // prepare service worker code as string. We'll inject the current page pathname to precache.
  const pagePath = location.pathname || './';
  const swCode = `
    const CACHE_NAME = 'blocksys-singlefile-v1';
    const PRECACHE = [
      ${JSON.stringify(pagePath)},
      './',
      './operating-form.html'
    ];
    self.addEventListener('install', evt => {
      evt.waitUntil(
        caches.open(CACHE_NAME).then(cache => cache.addAll(PRECACHE)).then(() => self.skipWaiting())
      );
    });
    self.addEventListener('activate', evt => {
      evt.waitUntil(
        caches.keys().then(keys => Promise.all(keys.map(k => { if (k !== CACHE_NAME) return caches.delete(k); }))).then(() => self.clients.claim())
      );
    });
    self.addEventListener('fetch', evt => {
      const req = evt.request;
      // navigation requests: try network, fallback to cached page
      if (req.mode === 'navigate') {
        evt.respondWith(
          fetch(req).then(r => { return r; }).catch(() => caches.match(${JSON.stringify(pagePath)}))
        );
        return;
      }
      evt.respondWith(
        caches.match(req).then(cached => {
          if (cached) return cached;
          return fetch(req).then(net => {
            if (net && net.type === 'basic' && net.status === 200) {
              caches.open(CACHE_NAME).then(c => c.put(req, net.clone()));
            }
            return net;
          }).catch(()=> caches.match(${JSON.stringify(pagePath)}));
        })
      );
    });
  `;

  // register service worker from a blob so everything stays in one file
  if ('serviceWorker' in navigator) {
    try {
      const swBlob = new Blob([swCode], {type: 'application/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl).then(reg => {
        console.log('Service worker (single-file) registered at', reg.scope);
      }).catch(err => {
        console.warn('SW registration failed:', err);
      });
    } catch (err) {
      console.warn('SW blob creation failed', err);
    }
  } else {
    console.warn('Service workers unsupported in this browser');
  }

})();

/* ----------------------------
   The original app code starts here (unchanged logic).
   I preserved your original data and UI behavior, with minor replacements
   to avoid external fonts/icons (we already replaced FA with inline SVGs).
   ---------------------------- */

(function(){
  try {
    function el(id){ return document.getElementById(id); }
    function clearChildren(node){ while(node && node.firstChild) node.removeChild(node.firstChild); }
    function escapeHtml(unsafe) { if (unsafe === undefined || unsafe === null) return ""; return String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\"/g,"&quot;").replace(/'/g,"&#039;"); }
    function looksLikeHtml(s){ if (typeof s !== 'string') return false; const t = s.trim(); return /^<[\s\S]+>$/.test(t); }
    function isLeafObject(obj){ if (typeof obj !== "object" || obj === null) return false; return Object.values(obj).every(v => v === null || typeof v === "string" || typeof v === "number" || typeof v === "boolean" || Array.isArray(v)); }

    const ABS_DATA = {
      "Normal Authority to Proceed": {
        "Single Line": "<div class='card-box'><div class='card-line'>OFF aspect of LSS</div></div>",
        "Double Line": "<div class='card-box'><div class='card-line'>OFF aspect of LSS</div></div>"
      },
      "Signal Failure": {
        "Block Instrument/Advance Starter": {
          "Single Line": "<div class='card-box'><div class='card-line'>PLCT</div><div class='card-line'>(T/C 1425 or T/D 1425)</div></div>",
          "Double Line":  "<div class='card-box'><div class='card-line'>T/369(3b) + PN</div></div>"
        },
        "Home Signal": "<div class='card-box'><div class='card-line'>Calling On Signal</div></div>"+"<div class='card-or'>or</div>"+"<div class='card-box'><div class='card-line'>T/369(3b) + PHS</div><div class='card-line'>(Speed 15 kmph)</div></div>",
        "Starter Signal": "<div class='card-box'><div class='card-line'>Calling On Signal, if provided</div></div>"+"<div class='card-or'>or</div>"+" <div class='card-box'><div class='card-line'>T/369(3b) + PHS</div><div class='card-line'>(Speed 15 kmph (max))</div></div>",
        "Shunt Signal":  "<div class='card-box'><div class='card-line'>Written Advice + PHS</div></div>",
        "Shunting Permitted Indicator (SPI)": "<div class='card-box'><div class='card-line'>Endorsement on T/806 + PHS</div></div>"
      },
      "Other Occasions": {
        "Reception on Non-Signalled Line": {
          "": "<div class='card-box'><div class='card-line'>[T/510 or T/369(3b)]</div><div class='card-line'>+</div><div class='card-line'>Piloting</div></div>"+"<div class='card-or'>or</div>"+"  <div class='card-box'><div class='card-line'>As per SWR</div></div>"
        },
        "Reception on Obstructed Road": {
          "": "<div class='card-box'><div class='card-line'>Calling On</div></div>"+"<div class='card-or'>or</div>"+"<div class='card-box'><div class='card-line'>T/509 + Piloting</div></div>"
        },
        "To Start from Non-Signalled Line": {
          "": "<div class='card-box'><div class='card-line'>T/511</div><div class='card-line'>+</div><div class='card-line'>OFF aspect of LSS</div><div class='card-line'>+</div><div class='card-line'>Pilot Out</div></div>"
        },
        "Starting from Non-Signalled Line when LSS failed": {
          "": "<div class='card-box'><div class='card-line'>T/511</div><div class='card-line'>+</div><div class='card-line'>Authority To Proceed</div><div class='card-line'>+</div><div class='card-line'>Pilot Out</div></div>"
        },
        "Despatch from a line having Common Starter": {
          "": "<div class='card-box'><div class='card-line'>T/512</div><div class='card-line'>+</div><div class='card-line'>Authority To Proceed</div><div class='card-line'>+</div><div class='card-line'>Pilot Out</div></div>"
        },
        "For sending Relief Engine/Train in Obstructed Block Section": {
          "": "<div class='card-box'><div class='card-line'>T/A 602</div><div class='card-line'>(Speed - 15/10/walking speed)</div></div>"
        },
        "To start the front portion of a Goods Train from Mid-Section": {
          "": "<div class='card-box'><div class='card-line'>T/609</div><div class='card-line'>(without LV board)</div></div>"
        },
        "To send relief engine to clear rear portion (if front portion comes with T/609)": {
          "": "<div class='card-box'><div class='card-line'>T/A 602</div><div class='card-line'>(Speed - 15/10/walking speed)</div></div>"
        }
      },
      "Shunting": {
        "Within the Station Section": {
          "Single Line/Double Line": "<div class='card-box'><div class='card-line'>T/806</div></div>"
        },
        "Beyond Advance Starter and upto oppsite FSS": "<div class='card-box'><div class='card-line'>T/806</div><div class='card-line'>+</div><div class='card-line'>Shunt Key</div></div>",
        "Beyond FSS (Block Back)": "<div class='card-box'><div class='card-line'>T/806</div><div class='card-line'>+</div><div class='card-line'>Shunt Key</div><div class='card-line'>+</div><div class='card-line'>Private Number</div></div>",
        "Behind a Departed Train": "<div class='card-box'><div class='card-line'>Permitted Upto FSS</div><div class='card-line'>with</div><div class='card-line'>T/806 + Shunt Key</div></div>",
        "In Advance of LSS (Block Forward) - On Double Line": "<div class='card-box'><div class='card-line'>T/806</div><div class='card-line'>+</div><div class='card-line'>Private Number</div></div>",
        "In rear of Outermost Facing Points or BSLB/wrong line (Block Back) - On Double Line": "<div class='card-box'><div class='card-line'>T/806</div><div class='card-line'>+</div><div class='card-line'>Private Number</div></div>"
      },
      "Engine Pushing": {
        "Permission": "<div class='card-box'><div class='card-line'>TMR written permission upto FSS</div></div>",
        "SM to Permit": "<div class='card-box'><div class='card-line'>From FSS, SM to furnish with written order</div><div class='card-or'>or</div><div class='card-line'>Take OFF approach reception signal</div></div>",
        "Engine Pushing Speed when TMR in leading vehicle (BV)": "<div class='card-box'><div class='card-line'>25kmph during Day</div><div class='card-line'>8 kmph during Night</div></div>"
      },
      "TSL working": {
        "Right Direction": "<div class='card-box'><ul class='card-html left'><li>Double Line working is 'Suspended'</li><li>Ensure one line is clear</li><li>LSS cannot be taken OFF</li><li><strong>Authority - T/D 602 (3 parts)</strong></li><li>Caution Order (Endorsement)</li><li>First Train - 25 kmph</li><li>If first train is ART/SPARMV - Normal Speed</li><li>Second and Subsequent train - MPS</li><li>Protection - as per GR 6.03</li><li>Train can be received on Signal at next Station</li><li>In case of failure of FSS, train to be dealt accordingly</li></ul></div>",
        "Wrong Direction": "<div class='card-box'><ul class='card-html left'><li>Double Line working is 'Suspended'</li><li>Ensure one line is clear</li><li>LSS not available on Wrong Line</li><li><strong>Authority - T/D 602 (3 parts) + Pilot Out Memo</strong></li><li>Flasher Light to be kept ON</li><li>Caution Order (Endorsement)</li><li>LPs ensure for 'Neutral Section'</li><li>First train 25 kmph</li><li>If first train is ART/SPARMV - Normal Speed</li><li>Second and Subsequent train - MPS</li><li>Protection - as per GR 6.03</li><li>LP to STOP at the Opposite FSS or LSS</li><li>Next Station - Train will be piloted with 'Pilot in Memo (T/510)'</li></ul></div>"
      },
      "TIC on Single Line": {
        "Document for Opening Communication": "<div class='card-box'><div class='card-line'>T/B 602 (5 parts)</div></div>",
        "For more than One Train": "<div class='card-box'><div class='card-line'>T/E 602</div></div>",
        "Signals": "<div class='card-box'><div class='card-line'>Except LSS, fixed signals can be taken OFF</div></div>",
        "Speed":  "<div class='card-box'><div class='card-line'>15/10/walking speed</div></div>",
        "Tunnel": "<div class='card-box'><div class='card-line'>Visibility clearance to be ascertained</div></div>",
        "Note": "<div class='card-box'><div class='card-line'>SM not to obstruct the line beyond outermost facing point</div></div>",
        "Line Clear Reply": "<div class='card-box'><div class='card-line'>T/F 602</div></div>",
        "Conditional Line Clear Ticket": "<div class='card-box'><div class='card-line'>[T/G 602 or T/H 602]</div><div class='card-line'>+</div><div class='card-line'>T/369(3b)</div></div>",
        "Speed while Returning": "<div class='card-box'><div class='card-line'>Booked Speed</div></div>",
        "At mid section": "<div class='card-box'><div class='card-line'>When two engines meet, LP and TMR will decide</div></div>",
        "If only Engine or Engine + BV": "<div class='card-box'><div class='card-line'>T/B 602</div><div class='card-line'>(use only first 3 parts)</div></div>",
        "Uneven Flow (one direction)": "<div class='card-box'><div class='card-box'><div class='card-line'><b>First Train</b></div><div class='card-line'>Booked Speed</div></div><div class='card-box'><div class='card-line'><b>Second and Subsequent</b></div><div class='card-line'>25/10 kmph</div><div class='card-line'>at 30 minute interval</div></div></div>",
        "Even Flow (both direction)": "<div class='card-box'><div class='card-line'>All trains at Normal Speed</div></div>",
        "Protection": "<div class='card-box'><div class='card-line'>250+250+10 meters</div></div>"
      },
      "TIC on Double Line": {
        "Document for Opening Communication":"<div class='card-box'><div class='card-line'>T/C 602 (3 parts)</div></div>",
        "Signals": "<div class='card-box'><div class='card-line'>Except LSS, fixed signals can be taken OFF</div></div>",
        "Speed": "<div class='card-box'><div class='card-line'>25/10/walking speed</div></div>",
        "Tunnel": "<div class='card-box'><div class='card-line'>Visibility clearance to be ascertained</div></div>",
        "Interval": "<div class='card-box'><div class='card-line'>30 minutes after every train</div></div>",
        "Protection": "<div class='card-box'><div class='card-line'>250+250+10 meters</div></div>",
        "Backing of Train": "<div class='card-box'><div class='card-line'>Prohibited, except unavoidable circumstances</div></div>",
        "At the FSS of Receiving Station": "<div class='card-box'><div class='card-line'>LP to stop at FSS and whistle continuous, if no response within 10 minutes from SM, send ALP to Station, TMR to Protect</div></div>"
      },

"TIC in TSL": {
  "Document for Opening Communication": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/B 602 + T/D 602</div></div><div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>15/10/Walking Speed</div></div><div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>Follow the Procedures for TIC on Single Line of Absolute Block System</div></div></div>",

  "For Train movements on Conditional Line Clear Ticket (either Wrong Line or Right Line)":
  "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/G 602 or T/H 602</div><div class='card-line'>+</div><div class='card-line'>T/369(3b)</div></div>   <div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>         <div class='card-box'><div class='card-line'><i>Uneven Flow</i></div><ul class='card-html left'><li>First Train - Booked Speed</li><li>Second and Subsequent Trains - 25/10 kmph, after an interval of 30 minutes</li></ul></div>  <div class='card-box'><div class='card-line'><i>Even Flow</i></div><ul class='card-html left'><li>All Trains - Normal Speed</li></ul></div></div></div><div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>Follow the procedure for TIC on Single Line of Absolute Block System in case of even flow/uneven flow</div></div><div class='card-box'><div class='card-line'><b>Protection</b><br/><br/>250+250+10 meters</div></div><div class='card-box'><div class='card-line'><b>Reception</b><br/><br/><ul class='card-html left'><li><i>On Wrong Line</i> - Stop at the Opposite FSS or LSS of the receiving Station and the Train will then be 'Piloted In'</li><li><i>On Right Line</i> - The approach signal may be taken off</li></ul></div></div><div class='card-box'><div class='card-line'><b>NOTE</b><br/><br/>Whenever Trains are dealt on the Wrong Line, <b>Pilot Out</b> will be done using <b>T/511</b> or <b>Pilot Out Memo</b>, and <b>Pilot In</b> at the receiving station will be done using <b>T/510</b></div></div></div>"

},

      "Procedure to Pass Gate Stop Signal at ON":
        "<div class='card-box'><ul class='card-html left'><li>Stop at the Gate Stop Signal</li><li>Sound a Long Whistle</li><li>Wait for 1 minute by day and 2 minutes by night</li><li>Ensure 'G' marker below Stop signal</li><li>Proceed cautiously</li><li>If Hand Signalled by Gateman, then Proceed.<br/>If NOT, Stop 30 meters before the LC Gate</li><li>Ensure the LC Gate is closed</li><li>Pass the LC only when Hand Signalled by TMR or one of the Engine Crew</li><li>After the last vehicle clears, stop with clearance of about two vehicle lengths beyond the Gate.</li><li>TMR or Engine Crew to re-open the LC Gate</li><li>TMR/LP to report the occurrence at the next Station</li></ul></div>",
      "Reporting of Rough/Slack Running - Lurch":
        "<div class='card-box'><ul class='card-html left'><li>Stop the Train <b>without clearing the Block Section</b></li><li>Inform the Station Master through <b>available means of communication</b></li><li>On arrival at Station, give <b>written advice</b> to the Station Master</li></ul></div>",
      "Goods Train Without Brake Van/ TMR": {
        "Permitted By":
          "<div class='card-box'><div class='card-line'><b>Without BV</b></div><div class='card-line'>Special Instruction</div></div>" +
          "<div class='card-box'><div class='card-line'><b>Without TMR</b></div><div class='card-line'>Regional Operating Instruction</div></div>",
        "Speed":
          "<div class='card-box'><div class='card-line'><b>Without BV</b></div><div class='card-line'>Normal Speed</div></div>" +
          "<div class='card-box'><div class='card-line'><b>Without TMR</b></div><div class='card-line'>Normal Speed<br/>(Not Permitted during TIC)</div></div>"
      }
    };


    
    const ATS_DATA = {
      "Failure of Automatic Signal/Signals in between Stations": {
  "": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>No Authority</div></div><div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>15 kmph, when view is clear<br/>10 kmph, when view is not clear</div></div><div class='card-box'><div class='card-line'><b>Precautions (GR/SR 9.02)</b><br/><br/><ul class='card-html left'><li>Stop at the foot of Signal</li><li>Wait for:<ul class='card-html left' style='list-style: none; margin-left:10px; padding-left:0;'><li style='list-style-type: none;'>â†’ 1 minute by day</li><li style='list-style-type: none;'>â†’ 2 minutes by night</li></ul></li><li>Ensure 'A' Marker</li><li>Blow one long whistle</li><li>Exchange signal with TMR</li><li>Follow speed restriction up to next Signal</li><li>After passing the Automatic Stop signal at â€˜ONâ€™, ensure a minimum separation of <b>150 metres</b> (or <b>two clear OHE masts</b> on electrified sections) from the preceding train/obstruction. This distance may be reduced to <b>75 metres</b> (or <b>one clear OHE mast</b>) when an EMU train is following.</li></ul></div></div></div>",
},

"Prolonged Failure of Signals": {
  "": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/D 912</div></div><div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>15 kmph, when view is clear<br/>10 kmph, when view is not clear</div></div><div class='card-box'><div class='card-line'><b>Precautions (GR/SR 9.02)</b><br/><br/><ul class='card-html left'><li>Stop at the foot of Signal</li><li>Wait for:<ul class='card-html left' style='list-style: none; margin-left:10px; padding-left:0;'><li style='list-style-type: none;'>â†’ 1 minute by day</li><li style='list-style-type: none;'>â†’ 2 minutes by night</li></ul></li><li>Ensure 'A' Marker</li><li>Blow one long whistle</li><li>Exchange signal with TMR</li><li>Follow speed restriction up to next Signal</li><li>After passing the Automatic Stop signal at â€˜ONâ€™, ensure a minimum separation of <b>150 metres</b> (or <b>two clear OHE masts</b> on electrified sections) from the preceding train/obstruction. This distance may be reduced to <b>75 metres</b> (or <b>one clear OHE mast</b>) when an EMU train is following.</li></ul></div></div></div>",
},

"Failure of Semi-Automatic Stop Signal, When Signal is 'ON' and Illuminated 'A' marker lit": {
  "": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>No Authority</div></div><div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>Stop Dead<br/>15 kmph, when visibility is clear up to the next Stop Signal<br/>10 kmph, when visibility is not clear up to the next Stop Signal</div></div><div class='card-box'><div class='card-line'><b>Precautions (GR/SR 9.02)</b><br/><br/><ul class='card-html left'><li>Stop at the foot of Signal</li><li>Wait for:<ul class='card-html left' style='list-style: none; margin-left:10px; padding-left:0;'><li style='list-style-type: none;'>â†’ 1 minute by day</li><li style='list-style-type: none;'>â†’ 2 minutes by night</li></ul></li><li>Ensure 'A' Marker</li><li>Blow one long whistle</li><li>Exchange signal with TMR</li><li>Follow speed restriction up to next Signal</li><li>After passing the Automatic Stop signal at â€˜ONâ€™, ensure a minimum separation of <b>150 metres</b> (or <b>two clear OHE masts</b> on electrified sections) from the preceding train/obstruction. This distance may be reduced to <b>75 metres</b> (or <b>one clear OHE mast</b>) when an EMU train is following.</li></ul></div></div></div>",
},

"Failure of Semi-Automatic Stop Signal (Last Stop Signal), when Signal is 'ON' and Illuminated 'A' marker extinguished": {
  "": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/369(3b)</div></div><div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>Stop Dead<br/>15 kmph, when visibility is clear up to the next Stop Signal<br/>10 kmph, when visibility is not clear up to the next Stop Signal</div></div><div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>Working as Manual Signal</div></div></div>",
},

"Sending Relief Engine / Train in Automatic Section": {
  "": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/C 912</div></div><div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>15 kmph â€” when view is clear<br/>10 kmph â€” when view is not clear</div></div><div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/><ul class='card-html left'><li>Starting from Wrong Line: Obtain <b>Pilot Out Memo</b>.</li><li>Stop at the specified kilometer and follow instructions of <b>TMR</b>.</li><li><b>Loco Pilot (LP)</b> to keep a sharp lookout ahead throughout the journey.</li><li>Ensure all <b>Level Crossing (LC) Gates</b> en route are properly closed before passing.</li><li>The LP shall stop at the foot of <b>FSS</b> or <b>LSS</b> (of the wrong line),</li><li>Sound one long whistle, and</li><li>Act as per the <b>Station Masterâ€™s (SM)</b> instruction.</li></ul></div></div></div>",
},

"Reporting of Rough/Slack running - Lurch in Automatic Block Section": {
  "": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Duties of LP and TMR</b><br/><br/><ul class='card-html left'><li>Stop the train in section.</li><li>Contact <b>Station Master (SM)</b> in rear and confirm for trains already left in the rear.</li><li>Do not start till the message is conveyed to the rear train LP by the <b>TMR</b> of the lurch-experienced train.</li><li>The LP of the lurch-experienced train may proceed further after giving a proper message to the LP of the rear train.</li><li>The rear train LP can pass the spot after duly ensuring safety â€” stop dead and pass at <b>10 kmph</b> if found safe.</li><li>The LP of the lurch-experienced first train shall report in writing at the next station.</li></ul></div></div></div>",
},

"Shunting": {
        "Upto LSS/ First Semi-Automatic Signal": {
          "Single Line/Double Line": "<div class='card-box'><div class='card-line'>T/806</div></div>"
        },
        "Beyond LSS but upto First Automatic Stop Signal": "<div class='card-box'><div class='card-line'>T/806</div><div class='card-line'>+</div><div class='card-line'>Written Memo</div><div class='card-line'>+</div><div class='card-line'>Private Number</div></div>",
        "Beyond the First Automatic Stop Signal (Block Forward)": "<div class='card-box'><div class='card-line'>(Ensure Section is Clear)</div><br/><div class='card-line'>T/806</div><div class='card-line'>+</div><div class='card-line'>Written Memo</div><div class='card-line'>+</div><div class='card-line'>Private Number</div></div>",
        "Shunting into the Block Section in Rear/Wrong direction (Block Back)": "<div class='card-box'><div class='card-line'>(Ensure Section is Clear)</div><br/><div class='card-line'>T/806</div><div class='card-line'>+</div><div class='card-line'>Written Memo</div><div class='card-line'>+</div><div class='card-line'>Private Number</div></div>",
        "Note": "<div class='card-box'><div class='card-line'>SM to ensure Semi-Automatic Signal to be kept in Manual Mode</div></div>",
       },
       
"Failure of Gate Stop Signal in Automatic Section (SR 9.15(2)/GR 9.02)": {
        "Semi-Automatic Gate Stop Signal at 'ON', 'A' marker is Glowing": {
  "": "<div class='card-box'><div class='card-line'><ul class='card-html left'><li><b>Stop Dead</b></li><li>Wait for <b>1 minute by day</b> and <b>2 minutes by night</b>.</li><li>Ensure <b>'G' marker</b> below Stop signal.</li><li>Sound one long whistle.</li><li>Exchange signal with <b>TMR</b>.</li><li>Proceed at <b>15 kmph</b> (when view is clear) or <b>10 kmph</b> (when not clear) up to the next Stop Signal.</li><li><b>LC Gate is closed</b>.</li><li>Follow procedure to pass <b>Automatic Signal at 'ON'</b>.</li></ul></div></div>",
},

"Semi-Automatic Gate Stop Signal at 'ON','A' marker is Extinguished, LC Gate is Closed and Gateman Showing Hand Signal": {
  "": "<div class='card-box'><div class='card-line'><ul class='card-html left'><li><b>Stop Dead</b></li><li>Wait for <b>1 minute by day</b> and <b>2 minutes by night.</b></li><li>Ensure <b>'G' marker</b> below Stop signal.</li><li>Sound one long whistle.</li><li>Exchange signal with <b>TMR.</b></li><li>Proceed <b>cautiously.</b></li><li>Ensure <b>LC Gate</b> is closed or obtain <b>Hand Signal</b> from Gateman.</li><li>Proceed at <b>15 kmph</b> (when view is clear) or <b>10 kmph</b> (when not clear) up to the next Stop Signal.</li><li>Follow procedure to pass <b>Automatic Signal at 'ON'.</b></li></ul></div></div>",
},

"Semi-Automatic Gate Stop Signal at 'ON','A' marker is Extinguished, LC Gate is Open": {
  "": "<div class='card-box'><div class='card-line'><ul class='card-html left'><li><b>Stop Dead.</b></li><li>Wait for <b>1 minute by day</b> and <b>2 minutes by night.</b></li><li>Ensure <b>'G' marker</b> below Stop signal.</li><li>Sound one long whistle.</li><li>Exchange signal with <b>TMR.</b></li><li>Proceed <b>cautiously up to LC Gate.</b></li><li>Stop <b>30 meters before the LC Gate.</b></li><li><b>ALP</b> to close the Gate, if <b>Gateman</b> is not available.</li><li>Pass the Gate cautiously and <b>stop after passing the Gate.</b></li><li><b>TMR</b> to open the Gate after the train passes.</li><li>Proceed at <b>15 kmph</b> (when view is clear) or <b>10 kmph</b> (when not clear) up to the next Stop Signal.</li><li>Follow procedure to pass <b>Automatic Signal at 'ON'.</b></li></ul></div></div>",
},

       },
      
"TSL Working": {
"Wrong Direction":
  "<div class='card-box'>"+"<div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/E 912</div></div>" +

  "<div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>" +
    "<ul class='card-html left'>" +
      "<li><b>First Train</b> â€“ 25 kmph</li>" +
      "<li><b>Subsequent Trains</b> â€“ Sectional Speed</li>" +
      "<li><b>At every change of direction, the First Train</b> â€“ 25 kmph</li>" +
    "</ul>" +
  "</div></div>" +

  "<div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>" +
    "<ul class='card-html left'>" +
      "<li>Issue <b>Pilot Out Memo</b></li>" +
      "<li>Switch ON flasher light</li>" +
      "<li>Whistle freely</li>" +
      "<li>Stop at Opposite LSS / Adjacent FSS of the receiving station</li>" +
      "<li>Sound one long whistle</li>" +
      "<li>Train will be received on <b>T/510</b></li>" +
      "<li>All trains will run with proper Line Clear</li>" +
    "</ul>" +
  "</div></div></div>",

  "Right Direction":
  "<div class='card-box'>"+"<div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/E 912</div></div>" +

  "<div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>" +
    "<ul class='card-html left'>" +
      "<li><b>First Train</b> â€“ 25 kmph</li>" +
      "<li><b>Subsequent Trains</b> â€“ Sectional Speed following signal aspects</li>" +
      "<li><b>At every change of direction, the First Train</b> â€“ 25 kmph</li>" +
    "</ul>" +
  "</div></div>" +

  "<div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>" +
    "<ul class='card-html left'>" +
      "<li>Starter / manually operated Gate Stop Signals â€“ hand-signalled</li>" +
      "<li>Train admitted on signal or on <b>T/369(3b)</b></li>" +
      "<li>Each First Train on Right Line will run on Line Clear</li>" +
      "<li>Subsequent trains will follow signal aspects</li>" +
    "</ul>" +
  "</div></div></div>"

},

"TIC on Double Line": {
  "": 
    "<div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/B 912</div></div>" +

    "<div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>" +
      "<ul class='card-html left'>" +
        "<li>15 kmph when view is clear</li>" +
        "<li>10 kmph when view is not clear</li>" +
        "<li>Facing Points â€“ 15 kmph</li>" +
      "</ul>" +
    "</div></div>" +

    "<div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>" +
      "<ul class='card-html left'>" +
        "<li>Tunnel should be piloted</li>" +
        "<li>Protection: 250 + 250 + 10 metres</li>" +
        "<li>Following train at an interval of 25 minutes</li>" +
        "<li>Stop at FSS; train will be received on T/369(3b)</li>" +
      "</ul>" +
    "</div></div>"

},




"TIC in TSL": {
  "Opening Communication, either on Wrong line or Right line": "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/B 602 + T/A 912</div></div><div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>15/10/Walking Speed</div></div><div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>Follow the Procedures for TIC on Single Line of Automatic Block System(SR 9.12(4) Unified SR)</div></div></div>",

  "For Train movements on Conditional Line Clear Ticket (either Wrong Line or Right Line)":
  "<div class='card-box'><div class='card-box'><div class='card-line'><b>Authority</b><br/><br/>T/G 602 or T/H 602</div><div class='card-line'>+</div><div class='card-line'>T/A 912</div></div>   <div class='card-box'><div class='card-line'><b>Speed</b><br/><br/>         <div class='card-box'><div class='card-line'><i>Uneven Flow</i></div><ul class='card-html left'><li>First Train - Booked Speed</li><li>Second and Subsequent Trains - 25/10 kmph, after an interval of 30 minutes</li></ul></div>  <div class='card-box'><div class='card-line'><i>Even Flow</i></div><ul class='card-html left'><li>All Trains - Normal Speed</li></ul></div></div></div><div class='card-box'><div class='card-line'><b>Precautions</b><br/><br/>Follow the procedure for TIC on Single Line of Automatic Block System in case of even flow/uneven flow (USR 9.12(4)</div></div><div class='card-box'><div class='card-line'><b>Protection</b><br/><br/>250+250+10 meters</div></div><div class='card-box'><div class='card-line'><b>Reception</b><br/><br/><ul class='card-html left'><li><i>On Wrong Line</i> - Stop at the Opposite FSS or LSS of the receiving Station and the Train will then be 'Piloted In'</li><li><i>On Right Line</i> - The approach signal may be taken off</li></ul></div></div><div class='card-box'><div class='card-line'><b>NOTE</b><br/><br/>Whenever Trains are dealt on the Wrong Line, <b>Pilot Out</b> will be done using <b>T/511</b> or <b>Pilot Out Memo</b>, and <b>Pilot In</b> at the receiving station will be done using <b>T/510</b></div></div></div>"

},


     "Engine Push back in Automatic Section (G&SR 9.13)": {
        "": "<div class='card-box'><b>Engine Pushing is Prohibited in Automatic Section, However in an Emergency following points to be kept in mind :</><ul class='card-html left'><li>Inform Station Master in rear/Section Controller</li><li>Permission shall be given by SM in rear to push back the train</li><li>SM in rear can give the permission, provided no train has been started in behind</li><li>The Permission shall be message supported by Private Number and ensure that LC Gates are closed</li><li>Speed during Push backing shall be with great caution not exceeding 10 kmph</li></ul></div>",

},

 };


    /* ------------------------------
       NEW: Miscellaneous data object (placeholder entries)
       Replace with real content as needed.
       ------------------------------ */
    const MISC_DATA = {
      "Accident Alarm/Siren/Hooter Code":
  "<div class='card-box'>" +
    "<table style='width:100%; border-collapse:collapse; font-size:0.95rem;'>" +
      "<tr><td style='padding:8px; border-bottom:4px solid #ddd; text-align:center;'>" +
        "<div class='card-line'><b>Two Long Blasts</b><br/><br/>(45 seconds each, with a 5-second break in between)</div>" +
      "</td></tr>" +
      "<tr><td style='padding:8px;'><div class='card-line'>Accident in Loco or Traffic Yard at <b>Home Station</b><br/><br/>Only <b>ART</b> required</div></td></tr>" +
    "</table>" +
  "</div>" +

  "<div class='card-box'>" +
    "<table style='width:100%; border-collapse:collapse; font-size:0.95rem;'>" +
      "<tr><td style='padding:8px; border-bottom:4px solid #ddd; text-align:center;'>" +
        "<div class='card-line'><b>Three Long Blasts</b><br/><br/>(45 seconds each, with a 5-second break in between)</div>" +
      "</td></tr>" +
      "<tr><td style='padding:8px;'><div class='card-line'>Accident <b>Outside Home Station</b><br/><br/>Only <b>ART</b> required</div></td></tr>" +
    "</table>" +
  "</div>" +

  "<div class='card-box'>" +
    "<table style='width:100%; border-collapse:collapse; font-size:0.95rem;'>" +
      "<tr><td style='padding:8px; border-bottom:4px solid #ddd; text-align:center;'>" +
        "<div class='card-line'><b>Four Long Blasts</b><br/><br/>(45 seconds each, with a 5-second break in between)</div>" +
      "</td></tr>" +
      "<tr><td style='padding:8px;'><div class='card-line'>Accident at <b>Home Station</b><br/><br/><b>ARM & MFDTV + ART</b> required.</div></td></tr>" +
    "</table>" +
  "</div>" +

  "<div class='card-box'>" +
    "<table style='width:100%; border-collapse:collapse; font-size:0.95rem;'>" +
      "<tr><td style='padding:8px; border-bottom:4px solid #ddd; text-align:center;'>" +
        "<div class='card-line'><b>Five Long Blasts</b><br/><br/>(45 seconds each, with a 5-second break in between)</div>" +
      "</td></tr>" +
      "<tr><td style='padding:8px;'><div class='card-line'>Accident <b>Outside Home Station</b><br/><br/><b>ARM & MFDTV + ART</b> required.</div></td></tr>" +
    "</table>" +
  "</div>" +

  "<div class='card-box'>" +
    "<table style='width:100%; border-collapse:collapse; font-size:0.95rem;'>" +
      "<tr><td style='padding:8px; border-bottom:4px solid #ddd; text-align:center;'>" +
        "<div class='card-line'><b>One Long Blast</b><br/><br/>(90 seconds continuous)</div>" +
      "</td></tr>" +
      "<tr><td style='padding:8px;'><div class='card-line'>Cancellation of <b>ARM & MFDTV / ART</b> <br/>or<br/><b>Testing</b> of the hooter.</div></td></tr>" +
    "</table>" +
  "</div>"
    ,
      "Local Circulars": "<div class='card-box'><div class='card-line'>Circular 01/2025 - Entry procedures</div></div>",
      "Emergency Contacts": "<div class='card-box'><div class='card-line'>Station Master: 0123456789</div><div class='card-line'>Control Room: 0987654321</div></div>"
    };

    const data = {
      "Absolute Block System": ABS_DATA,
      "Automatic Block Section": ATS_DATA,
      "Miscellaneous": MISC_DATA
    };

    const BACK_BTN = document.querySelector('.back-btn');
    const SELECTION_PAGE = el("selectionPage");
    const SYSTEM_PAGE = el("systemPage");
    const CIRC_GRID = el("circumstancesGrid");
    const SUBMENU_GRID = el("subMenuGrid");
    const AUTH_CARD = el("authorityCard");
    const SYSTEM_MAIN = el("systemMain");
    const PARENT_HEADING = el("parentHeading");
    const PARENT_HEADING_TEXT = el("parentHeadingText");

    function debounce(fn, wait = 120) {
      let t = null;
      return function(...args) {
        clearTimeout(t);
        t = setTimeout(() => fn.apply(this, args), wait);
      };
    }

    function updateSubheaderOffset(){
      try {
        const headerEl = document.querySelector('header');
        const subheaderEl = document.querySelector('.subheader');
        if (!headerEl) return;
        const headerRect = headerEl.getBoundingClientRect();
        const subRect = subheaderEl ? subheaderEl.getBoundingClientRect() : { height: 0 };
        const headerH = Math.ceil(headerRect.height || 0);
        const subH = Math.ceil(subRect.height || 0);
        if (subheaderEl) { subheaderEl.style.top = headerH + 'px'; subheaderEl.style.position = 'sticky'; subheaderEl.style.zIndex = 105; }
        headerEl.style.position = 'sticky'; headerEl.style.top = '0px'; headerEl.style.zIndex = 110;
        if (PARENT_HEADING) { PARENT_HEADING.style.top = (headerH + subH) + 'px'; PARENT_HEADING.style.position = 'sticky'; PARENT_HEADING.style.zIndex = 104; }
        const viewportH = window.innerHeight || document.documentElement.clientHeight;
        const available = Math.max(120, viewportH - headerH - subH - 12);
        if (SYSTEM_MAIN) { SYSTEM_MAIN.style.height = (available + subH) + 'px'; SYSTEM_MAIN.style.overflowY = 'auto'; }
        if (CIRC_GRID) { CIRC_GRID.style.maxHeight = 'none'; CIRC_GRID.style.overflowY = 'visible'; }
        if (SUBMENU_GRID) { SUBMENU_GRID.style.maxHeight = 'none'; SUBMENU_GRID.style.overflowY = 'visible'; }
        if (AUTH_CARD) {
          const cardHeading = AUTH_CARD.querySelector('.sub-heading');
          const cardHeadingH = cardHeading ? Math.ceil(cardHeading.getBoundingClientRect().height || 0) : 56;
          const body = AUTH_CARD.querySelector('.card-body');
          if (body) {
            const bodyMax = Math.max(120, available - cardHeadingH - 24);
            body.style.maxHeight = bodyMax + 'px';
            body.style.overflowY = 'auto';
            body.style.webkitOverflowScrolling = 'touch';
          }
          AUTH_CARD.style.maxHeight = Math.max(200, viewportH - headerH - 24) + 'px';
        }
      } catch (err) {
        console.warn('updateSubheaderOffset error', err);
      }
    }

    function setParentHeading(text) {
      if (!PARENT_HEADING || !PARENT_HEADING_TEXT) return;
      if (text) { PARENT_HEADING_TEXT.textContent = text; PARENT_HEADING.style.display = 'block'; }
      else { PARENT_HEADING_TEXT.textContent = ''; PARENT_HEADING.style.display = 'none'; }
    }

    // Toggle background inertness (simple): mark selection/system pages aria-hidden and body scroll lock
    function setBackgroundInert(isInert) {
      try {
        if (SELECTION_PAGE) SELECTION_PAGE.setAttribute('aria-hidden', String(isInert));
        if (SYSTEM_PAGE) SYSTEM_PAGE.setAttribute('aria-hidden', String(isInert));
        if (isInert) document.documentElement.classList.add('no-scroll'), document.body.classList.add('no-scroll');
        else document.documentElement.classList.remove('no-scroll'), document.body.classList.remove('no-scroll');
      } catch (e) { /* fail silently */ }
    }
    
    

    window.addEventListener('load', updateSubheaderOffset);
    window.addEventListener('resize', debounce(updateSubheaderOffset, 130));

    function loadCircumstances(){
      setParentHeading(null);
      clearChildren(CIRC_GRID);
      const systemData = data[currentSystem] || {};
      Object.keys(systemData).forEach(circ => {
        const div = document.createElement("div");
        div.className = "grid-item";
        div.tabIndex = 0;
        div.setAttribute("role", "button");
        div.setAttribute("aria-controls","authorityCard");
        div.setAttribute("aria-expanded","false");
        div.textContent = circ;
        div.onclick = () => showSubMenu(circ);
        div.onkeydown = (e) => { if(e.key === "Enter" || e.key === " ") showSubMenu(circ); };
        CIRC_GRID.appendChild(div);
      });
      CIRC_GRID.style.display = "grid";
      SUBMENU_GRID.style.display = "none";
      AUTH_CARD.style.display = "none";
      SYSTEM_MAIN.scrollTop = 0;
      updateSubheaderOffset();
    }

    function showSubMenu(circ){
        currentCircumstance = circ;
  if (window.__pushSubmenuState) window.__pushSubmenuState(circ);

      if (circ === "Signal Failure" || circ === "Shunting") { setParentHeading(circ); } else { setParentHeading(null); }
      const subData = data[currentSystem] && data[currentSystem][circ];
      if ( circ === "TIC on Single Line" || circ === "TIC on Double Line" || !subData || typeof subData !== "object" || isLeafObject(subData) ) {
        openedFromSubmenu = false; showAuthority(circ, true); return;
      }
      clearChildren(SUBMENU_GRID);
      Object.keys(subData).forEach(sub => {
        const div = document.createElement("div");
        div.className = "grid-item";
        div.tabIndex = 0;
        div.setAttribute("role", "button");
        div.setAttribute("aria-controls","authorityCard");
        div.setAttribute("aria-expanded","false");
        div.textContent = sub;
        div.onclick = () => { openedFromSubmenu = true; showAuthority(sub); };
        div.onkeydown = (e) => { if(e.key === "Enter" || e.key === " ") { openedFromSubmenu = true; showAuthority(sub); } };
        SUBMENU_GRID.appendChild(div);
      });
      CIRC_GRID.style.display = "none";
      SUBMENU_GRID.style.display = "grid";
      AUTH_CARD.style.display = "none";
      updateSubheaderOffset();
      SYSTEM_MAIN.scrollTop = 0;
      setTimeout(()=>{ const first = SUBMENU_GRID.querySelector('.grid-item'); if(first) first.focus(); },80);
    }

    function renderStringOrHtml(val){
      if (looksLikeHtml(val)) return `<div class="card-html">${val}</div>`;
      const parts = String(val).split('\n').map(p => p.trim());
      let out = '';
      parts.forEach(line => {
        if (line.toLowerCase() === 'or') out += `<p class="or-text" style="text-align:center;margin:0;">${escapeHtml(line)}</p>`;
        else out += `<p style="margin:0 0 6px 0;text-align:center;">${escapeHtml(line)}</p>`;
      });
      return out;
    }

    // small counter for heading ids
    let __authorityHeadingCounter = 0;

    function showAuthority(sub, direct = false) {
      let subData;
      if (direct) subData = data[currentSystem] && data[currentSystem][sub];
      else subData = data[currentSystem] && data[currentSystem][currentCircumstance] && data[currentSystem][currentCircumstance][sub];

      const parentVisible = (!direct && currentCircumstance &&
          (currentCircumstance === "Signal Failure" || currentCircumstance === "Shunting"));

      let html = "";
      const shouldSuppressInnerHeading = parentVisible && (sub === "Signal Failure" || sub === "Shunting");

      // create a unique heading id and set aria-labelledby on the card for screen readers
      const headingId = 'authority-heading-' + (Date.now().toString(36)) + '-' + (__authorityHeadingCounter++);
      if (!shouldSuppressInnerHeading) {
        html += `<div id="${headingId}" class="sub-heading sub-heading-small">${escapeHtml(sub)}</div>`;
      } else {
        // include a visually-hidden heading to keep aria-labelledby meaningful
        html += `<div id="${headingId}" class="sub-heading sub-heading-small hidden-subheading-spacer" aria-hidden="true"></div>`;
      }

      html += `<div class="card-body" tabindex="0" role="region" aria-live="polite">`;

      if (typeof subData === "string") {
        html += renderStringOrHtml(subData);
      }
      else if (Array.isArray(subData)) {
        const anyHtml = subData.some(item => looksLikeHtml(item));
        if (anyHtml) {
          subData.forEach(item => {
            if (looksLikeHtml(item)) html += `<div class="card-html">${item}</div>`;
            else html += renderStringOrHtml(String(item));
          });
        } else {
          const hasOr = subData.some(v => String(v).toLowerCase() === "or");
          if (currentCircumstance === "TSL working" || /TSL working/i.test(sub)) {
            html += `<ul>`;
            subData.forEach(v => {
              const text = String(v);
              if (text.toLowerCase().includes("authority")) html += `<li><strong>${escapeHtml(text)}</strong></li>`;
              else html += `<li>${escapeHtml(text)}</li>`;
            });
            html += `</ul>`;
          } else if (hasOr) {
            html += `<div style="display:flex;flex-direction:column;gap:8px;align-items:center;">`;
            subData.forEach(v => {
              const text = String(v);
              if (text.toLowerCase() === "or") html += `<p class="or-text" style="margin:0;">${escapeHtml(text)}</p>`;
              else html += `<p class="card-line" style="margin:0;text-align:center;">${escapeHtml(text)}</p>`;
            });
            html += `</div>`;
          } else {
            html += `<ul>`;
            subData.forEach(v => html += `<li>${escapeHtml(String(v))}</li>`);
            html += `</ul>`;
          }
        }
      }
      else if (typeof subData === "object" && subData !== null) {
        const innerKeys = Object.keys(subData);
        innerKeys.forEach(key => {
          const isOnlyInnerKey = innerKeys.length === 1;
          html += `<div style="margin:18px 0;text-align:center;">`;
          if (key !== "" && !isOnlyInnerKey) {
            html += `<h4>${escapeHtml(key)}</h4>`;
          }
          const val = subData[key];
          if (typeof val === "string") {
            html += renderStringOrHtml(val);
          } else if (Array.isArray(val)) {
            const anyHtmlNested = val.some(item => looksLikeHtml(item));
            if (anyHtmlNested) {
              val.forEach(item => {
                if (looksLikeHtml(item)) html += `<div class="card-html">${item}</div>`;
                else html += renderStringOrHtml(String(item));
              });
            } else {
              const hasOrNested = val.some(v => String(v).toLowerCase() === "or");
              if (hasOrNested) {
                html += `<div style="display:flex;flex-direction:column;gap:8px;align-items:center;">`;
                val.forEach(item => {
                  const text = String(item);
                  if (text.toLowerCase() === "or") html += `<p class="or-text" style="margin:0;">${escapeHtml(text)}</p>`;
                  else html += `<p class="card-line" style="margin:0;text-align:center;">${escapeHtml(text)}</p>`;
                });
                html += `</div>`;
              } else {
                html += `<ul>`;
                val.forEach(item => html += `<li>${escapeHtml(String(item))}</li>`);
                html += `</ul>`;
              }
            }
          } else if (typeof val === "object" && val !== null) {
            html += `<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px;">`;
            Object.keys(val).forEach(subKey => {
              const v = val[subKey];
              if (typeof v === "string") {
                html += `<p style="margin:0;text-align:center;"><strong>${escapeHtml(subKey)}:</strong> ${escapeHtml(String(v))}</p>`;
              } else if (Array.isArray(v)) {
                html += `<p style="margin:0;text-align:center;"><strong>${escapeHtml(subKey)}:</strong> ${escapeHtml(v.join(", "))}</p>`;
              } else {
                html += `<p style="margin:0;text-align:center;"><strong>${escapeHtml(subKey)}:</strong> ${escapeHtml(String(v))}</p>`;
              }
            });
            html += `</div>`;
          } else {
            html += `<p>${escapeHtml(String(val))}</p>`;
          }
          html += `</div>`;
        });
      } else {
        html += `<p>No data available</p>`;
      }

      html += `</div>`;
      AUTH_CARD.innerHTML = html;

      // set aria-labelledby for screen readers (use the heading id created above)
      try {
        AUTH_CARD.setAttribute('aria-labelledby', headingId);
      } catch (e) {}

      // theme class
      AUTH_CARD.classList.remove('abs','auto','misc');
      if (currentSystem === "Absolute Block System") AUTH_CARD.classList.add('abs');
      else if (currentSystem === "Automatic Block Section") AUTH_CARD.classList.add('auto');
      else if (currentSystem === "Miscellaneous") AUTH_CARD.classList.add('misc');

      // show dialog safely and mark background inert
      AUTH_CARD.style.flexDirection = 'column';
      AUTH_CARD.style.display = "flex";
      AUTH_CARD.setAttribute("aria-hidden", "false");
           if (window.__pushAuthorityState) window.__pushAuthorityState(sub);

      setBackgroundInert(true);

      updateSubheaderOffset();
      SYSTEM_MAIN.scrollTop = Math.max(0, SYSTEM_MAIN.scrollTop - 1);
      setTimeout(() => { SYSTEM_MAIN.scrollTop = Math.max(0, SYSTEM_MAIN.scrollTop + 1); }, 20);
      SUBMENU_GRID.style.display = "none";
      CIRC_GRID.style.display = "none";

      const bodyEl = AUTH_CARD.querySelector('.card-body');
      setTimeout(() => {
        if (bodyEl) try { bodyEl.focus(); } catch (e) {}
        const activeControls = document.querySelectorAll('[aria-controls="authorityCard"]');
        activeControls.forEach(c => c.setAttribute('aria-expanded','true'));
      }, 80);

      if (BACK_BTN) BACK_BTN.style.display = 'flex';
      if (BACK_BTN) BACK_BTN.focus();

      const focusTrap = (e) => {
        if (!AUTH_CARD || AUTH_CARD.style.display === "none") return;
        const root = AUTH_CARD;
        const focusable = root.querySelectorAll('a,button,input,textarea,select,[tabindex]:not([tabindex="-1"])');
        const arr = Array.prototype.slice.call(focusable);
        if (arr.length === 0) {
          if (e.key === 'Tab' && document.activeElement === document.body) { e.preventDefault(); try { bodyEl.focus(); } catch (err) {} }
          return;
        }
        const first = arr[0], last = arr[arr.length - 1];
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
          else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
        }
      };

      document.removeEventListener('keydown', window.__authFocusTrapHandler);
      window.__authFocusTrapHandler = function(e){ focusTrap(e); };
      document.addEventListener('keydown', window.__authFocusTrapHandler);
    }

    let currentSystem = "";
    let currentCircumstance = "";
    let openedFromSubmenu = false;
       // --------- History / Android back-button friendly behavior ---------
// call this once on startup to create the initial history state
(function setupHistoryNavigation(){
  // Normalize initial state
  if (!history.state) {
    history.replaceState({ screen: 'selection' }, '', location.pathname + location.search);
  }

  // push a state when we move to the system page
  const pushSystemState = (sysName) => {
    try {
      history.pushState({ screen: 'system', system: sysName }, '', '#system');
    } catch(e) { /* ignore */ }
  };

  // push a state when we show a submenu (parent)
  const pushSubmenuState = (parentKey) => {
    try {
      history.pushState({ screen: 'submenu', system: currentSystem, parent: parentKey }, '', '#submenu');
    } catch(e) { /* ignore */ }
  };

  // push a state when we show an authority/card dialog
  const pushAuthorityState = (authorityKey) => {
    try {
      history.pushState({ screen: 'authority', system: currentSystem, authority: authorityKey, parent: currentCircumstance }, '', '#authority');
    } catch(e) { /* ignore */ }
  };

  // When user presses hardware back, popstate fires; handle nav instead of letting app close.
  window.addEventListener('popstate', (evt) => {
    const s = (evt && evt.state) || {};
    // If state is missing, fall back to current visible UI
    const screen = s.screen || (document.getElementById('systemPage').style.display !== 'none' ? 'system' : 'selection');

    // If authority is open -> close card first
    const authVisible = AUTH_CARD && AUTH_CARD.style.display && AUTH_CARD.style.display !== 'none';

    if (screen === 'authority' && authVisible) {
      // This is a pop to authority â€” nothing to do. (rare)
      return;
    }

    if (authVisible) {
      // If card currently open, close it instead of exiting
      goBack(); // your existing function hides authority card and restores previous grid
      return;
    }

    // If submenu is open, go back to parent grid
    if (document.getElementById('subMenuGrid').style.display !== 'none') {
      goBack();
      return;
    }

    // If system page visible, but we're popping to selection -> go home
    if (document.getElementById('systemPage').style.display !== 'none' && (screen === 'selection' || !s.screen)) {
      goBack(); // returns to selection
      return;
    }

    // otherwise default behaviour: let browser handle (which may close app)
  });

  // Expose helpers so we can call them from your UI state transitions
  window.__pushSystemState = pushSystemState;
  window.__pushSubmenuState = pushSubmenuState;
  window.__pushAuthorityState = pushAuthorityState;

  // Double-back-to-exit fallback if already at selection screen
  let lastBackAtRoot = 0;
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' || e.key === 'Escape') {
      // don't treat these as exit on mobile hardware (Android uses popstate)
    }
  });
  // If Android sends no popstate and actually tries to close, we can't intercept that reliably,
  // but history management above will prevent most accidental closes.
})();

    function loadCircumstancesWrapper(){
      try { loadCircumstances(); } catch(e){ console.error('loadCircumstances failed', e); }
    }

    function selectSystem(system){
       currentSystem = system;
  if (window.__pushSystemState) window.__pushSystemState(system);
      SELECTION_PAGE.style.display = "none";
      SYSTEM_PAGE.style.display = "block";
      SYSTEM_PAGE.setAttribute("aria-hidden","false");
      el("systemTitle").textContent = system;
      const subheader = document.querySelector('.subheader');
      if (subheader) subheader.style.display = 'flex';
      updateSubheaderOffset();
      if (BACK_BTN) BACK_BTN.style.display = 'flex';
      loadCircumstancesWrapper();
      SYSTEM_MAIN.scrollTop = 0;
      buildMenu();
    }

    function goBack(){
      if (AUTH_CARD && AUTH_CARD.style.display && AUTH_CARD.style.display !== "none") {
        AUTH_CARD.style.display = "none";
        AUTH_CARD.setAttribute("aria-hidden", "true");
        setBackgroundInert(false);
        const activeControls = document.querySelectorAll('[aria-controls=\"authorityCard\"]');
        activeControls.forEach(c => c.setAttribute('aria-expanded','false'));
        if (window.__authFocusTrapHandler) { document.removeEventListener('keydown', window.__authFocusTrapHandler); window.__authFocusTrapHandler = null; }
        if (openedFromSubmenu) {
          SUBMENU_GRID.style.display = "grid";
          setTimeout(()=>{ const first = SUBMENU_GRID.querySelector('.grid-item'); if(first) first.focus(); },80);
        } else {
          CIRC_GRID.style.display = "grid";
          setTimeout(()=>{ const first = CIRC_GRID.querySelector('.grid-item'); if(first) first.focus(); },80);
        }
        openedFromSubmenu = false;
        return;
      }

      if (SUBMENU_GRID && SUBMENU_GRID.style.display && SUBMENU_GRID.style.display !== "none") {
        SUBMENU_GRID.style.display = "none";
        CIRC_GRID.style.display = "grid";
        setTimeout(()=>{ const first = CIRC_GRID.querySelector('.grid-item'); if(first) first.focus(); },80);
        openedFromSubmenu = false;
        setParentHeading(null);
        return;
      }

      if (SYSTEM_PAGE && SYSTEM_PAGE.style.display && SYSTEM_PAGE.style.display !== "none") {
        SYSTEM_PAGE.style.display = "none";
        SYSTEM_PAGE.setAttribute("aria-hidden", "true");
        SELECTION_PAGE.style.display = "block";
        const subheader = document.querySelector('.subheader');
        if (subheader) subheader.style.display = 'none';
        if (BACK_BTN) BACK_BTN.style.display = 'none';
        setTimeout(()=>{ const firstBlock = document.querySelector('.block'); if(firstBlock) firstBlock.blur(); },80);
        currentSystem = "";
        currentCircumstance = "";
        openedFromSubmenu = false;
        setParentHeading(null);
        return;
      }

      SELECTION_PAGE.style.display = "block";
      const subheaderFallback = document.querySelector('.subheader');
      if (subheaderFallback) subheaderFallback.style.display = 'none';
      if (BACK_BTN) BACK_BTN.style.display = 'none';
    }

    document.addEventListener('keydown', function(e){ if (e.key === 'Escape') { e.preventDefault(); goBack(); return; } });

    // safe click-outside handler
    document.addEventListener('click', function(e){
      if (!AUTH_CARD || AUTH_CARD.style.display === "none") return;
      const backBtnSafe = BACK_BTN || document.querySelector('.back-btn');
      if (!AUTH_CARD.contains(e.target) && !(backBtnSafe && backBtnSafe.contains(e.target))) {
        goBack();
      }
    }, true);

    function openMenu(){
      const overlay = document.getElementById('overlay'), side = document.getElementById('sideMenu');
      if (!side || !overlay) return;
      side.classList.add('open'); side.setAttribute('aria-hidden','false');
      overlay.classList.add('show'); overlay.setAttribute('aria-hidden','false');
      buildMenu();
      setTimeout(()=>{ const first = side.querySelector('button:not([disabled])'); if(first) first.focus(); },60);
    }
    function closeMenu(){
      const overlay = document.getElementById('overlay'), side = document.getElementById('sideMenu');
      if (!side || !overlay) return;
      side.classList.remove('open'); side.setAttribute('aria-hidden','true');
      overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true');
      const menuBtn = document.getElementById('menuBtn'); if(menuBtn) menuBtn.focus();
    }
    function goHomeFromMenu(){
      closeMenu();
      const sel = document.getElementById('selectionPage'), sys = document.getElementById('systemPage');
      if (sel && sys) { sel.style.display = 'block'; sys.style.display = 'none'; }
      currentSystem = '';
      currentCircumstance = '';
      openedFromSubmenu = false;
      setParentHeading(null);
      const subheader = document.querySelector('.subheader'); if (subheader) subheader.style.display='none';
      if (BACK_BTN) BACK_BTN.style.display='none';
    }

    function buildMenu(){
      const listEl = document.getElementById('menuList'), currSysEl = document.getElementById('menuCurrentSystem'), noteEl = document.getElementById('menuSystemNote');
      if (!listEl || !currSysEl) return;
      listEl.innerHTML = '';
      if (!currentSystem || !data || !data[currentSystem]) {
        currSysEl.textContent = 'â€”';
        if (noteEl) { noteEl.style.display = 'block'; noteEl.textContent = 'Select a system from the main screen to see its subfolders here.'; }
        return;
      }
      currSysEl.textContent = currentSystem;
      if (noteEl) noteEl.style.display = 'none';
      const systemData = data[currentSystem] || {};
      Object.keys(systemData).forEach(parentKey => {
        const parentVal = systemData[parentKey];
        const li = document.createElement('li');
        li.className = 'menu-parent';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = parentKey;
        btn.setAttribute('aria-expanded','false');

        const parentIsLeaf = (typeof parentVal === 'string') || Array.isArray(parentVal) || isLeafObject(parentVal);

        if (parentIsLeaf) {
          btn.onclick = () => {
            setParentHeading(null);
            currentCircumstance = parentKey;
            openedFromSubmenu = false;
            closeMenu();
            showAuthority(parentKey, true);
          };
          btn.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); } };
          li.appendChild(btn);
          listEl.appendChild(li);
          return;
        }

        btn.onclick = () => {
          showSubMenu(parentKey);
          const subheader = document.querySelector('.subheader'); if (subheader) subheader.style.display='flex';
          if (BACK_BTN) BACK_BTN.style.display='flex';
          li.classList.toggle('open');
          const opened = li.classList.contains('open');
          btn.setAttribute('aria-expanded', String(opened));
          closeMenu();
          setTimeout(buildMenu, 80);
        };
        btn.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); btn.click(); } };

        li.appendChild(btn);

        const ul = document.createElement('ul'); ul.className = 'submenu-list';
        Object.keys(parentVal || {}).forEach(childKey => {
          const childVal = parentVal[childKey];
          const childLi = document.createElement('li');
          const childBtn = document.createElement('button');
          childBtn.type = 'button';
          childBtn.textContent = childKey;

          const childIsLeaf = (typeof childVal === 'string') || Array.isArray(childVal) || isLeafObject(childVal);

          if (childIsLeaf) {
            childBtn.onclick = () => {
              showSubMenu(parentKey);
              openedFromSubmenu = true;
              currentCircumstance = parentKey;
              closeMenu();
              setTimeout(()=> { showAuthority(childKey); }, 60);
            };
            childBtn.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); childBtn.click(); } };
            childLi.appendChild(childBtn);
            ul.appendChild(childLi);
            return;
          }

          if (typeof childVal === 'object' && childVal !== null) {
            childBtn.onclick = () => {
              childLi.classList.toggle('open');
              li.classList.add('open');
              const opened = childLi.classList.contains('open');
              childBtn.setAttribute('aria-expanded', String(opened));
            };
            childBtn.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); childBtn.click(); } };
            childLi.appendChild(childBtn);

            const nestedUL = document.createElement('ul');
            Object.keys(childVal).forEach(level3Key => {
              const nli = document.createElement('li');
              const nbtn = document.createElement('button');
              nbtn.type = 'button';
              nbtn.textContent = level3Key;
              nbtn.onclick = () => {
                showSubMenu(parentKey);
                openedFromSubmenu = true;
                currentCircumstance = parentKey;
                closeMenu();
                setTimeout(()=> { showAuthority(level3Key); }, 60);
              };
              nbtn.onkeydown = e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); nbtn.click(); } };
              nli.appendChild(nbtn);
              nestedUL.appendChild(nli);
            });
            childLi.appendChild(nestedUL);
            ul.appendChild(childLi);
            return;
          }

          childBtn.disabled = true;
          childBtn.setAttribute('aria-disabled','true');
          childLi.appendChild(childBtn);
          ul.appendChild(childLi);
        });

        li.appendChild(ul);
        listEl.appendChild(li);
      });
    }

    document.getElementById('menuBtn').addEventListener('click', openMenu);
    document.getElementById('overlay').addEventListener('click', closeMenu);
    // Open real home page (index.html) when the side-menu Home button is clicked
document.getElementById('menuHomeBtn').addEventListener('click', function (e) {
  // prefer a same-origin relative navigation so it works offline / in PWA
  window.location.href = './index.html';
});

    window.selectSystem = selectSystem;
    window.goBack = goBack;
    window.openMenu = openMenu;
    window.closeMenu = closeMenu;
    window.buildMenu = buildMenu;

    window.addEventListener('load', function(){
      const subheader = document.querySelector('.subheader');
      if (subheader) { subheader.style.display = 'none'; subheader.setAttribute('aria-hidden', 'true'); }
      updateSubheaderOffset();
      setTimeout(()=>{ const first = document.querySelector('.block'); if(first) first.setAttribute('tabindex','0'); }, 40);
    });

  } catch (err) {
    console.error('Fatal script error:', err);
    alert('A script error occurred. Open DevTools Console (F12) and paste the error into chat so I can debug.');
  }
})();

/* Single-download/offline button: best-effort for the single-file SW above */
document.getElementById('downloadOffline').addEventListener('click', () => {
  if (!('serviceWorker' in navigator)) {
    showToast('âš ï¸ Offline support not available in this browser.');
    return;
  }

  if (!navigator.serviceWorker.controller) {
    showToast('ðŸ”„ Activating offline mode... please wait.');
    // Auto reload after short delay so SW takes control
    setTimeout(() => location.reload(), 1500);
    return;
  }

  // Success message once SW is active
  showToast('âœ… Page cached for offline use successfully!');
});

/* Simple toast message function */
function showToast(message) {
  const toast = document.createElement('div');
  toast.textContent = message;
  toast.style.position = 'fixed';
  toast.style.bottom = '20px';
  toast.style.left = '50%';
  toast.style.transform = 'translateX(-50%)';
  toast.style.background = '#1976d2'; // accent blue
  toast.style.color = 'white';
  toast.style.padding = '10px 18px';
  toast.style.borderRadius = '8px';
  toast.style.fontSize = '14px';
  toast.style.zIndex = '9999';
  toast.style.opacity = '0';
  toast.style.transition = 'opacity 0.5s ease';
  toast.style.boxShadow = '0 2px 8px rgba(0,0,0,0.3)';
  document.body.appendChild(toast);

  // Fade in
  requestAnimationFrame(() => (toast.style.opacity = '1'));

  // Fade out and remove after 3 seconds
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 500);
  }, 3000);
}

/* ===== Improved Home â†’ Abnormal Working flow (robust, delegation + native link) ===== */
(function(){
  const mainHeading = document.getElementById('mainHeading');
  const container = document.querySelector('.block-container');
  const SELECTION_PAGE = document.getElementById('selectionPage');
  const BACK_BTN = document.getElementById('backBtn');
  const SYSTEM_PAGE = document.getElementById('systemPage');
  const systemTitle = document.getElementById('systemTitle');

  const ORIGINAL_HEADER = mainHeading ? mainHeading.innerHTML : '';

  // render home tiles (keeps Operating Forms as real link)
  function showHome(){
    if (!container) return;
    container.innerHTML = `
      <div class="block abs" data-action="abnormal" tabindex="0" role="button" aria-pressed="false">
        Abnormal Working
      </div>

      <!-- Use a native anchor so browser navigation always works reliably -->
      <a class="block auto" href="./operating-form.html" role="link" aria-label="Open Operating Forms">
        Operating Forms
      </a>
    `;
    // inside showHome() â€” after you rebuild the home tiles
document.body.classList.remove('category-mode');

    // reset heading & state
    if (mainHeading) mainHeading.innerHTML = ORIGINAL_HEADER;
    if (systemTitle) systemTitle.textContent = '';
    window.currentCategory = null;

    // hide header back button
    if (BACK_BTN) BACK_BTN.style.display = 'none';
  }

  // render category tiles (Abnormal Working or Operating Forms category UI)
  function showCategory(name){
    if (!container) return;
    container.innerHTML = `
      <div class="block abs" data-action="select-system" data-system="Absolute Block System" tabindex="0" role="button" aria-pressed="false">
        Absolute Block System
      </div>

      <div class="block auto" data-action="select-system" data-system="Automatic Block Section" tabindex="0" role="button" aria-pressed="false">
        Automatic Block Section
      </div>

      <div class="block misc" data-action="select-system" data-system="Miscellaneous" tabindex="0" role="button" aria-pressed="false">
        Miscellaneous
      </div>

<div style="width:100%;text-align:center;margin-top:20px;">
  <button class="menu-pill" type="button" data-action="back-home" aria-label="Back to home">
    Back
  </button>
</div>
    `;
    // inside showCategory(name) â€” after you set the heading / before returning
document.body.classList.add('category-mode');

    // Uppercase title and keep it fixed while inside category
    if (mainHeading) mainHeading.innerHTML = `<span>${String(name).toUpperCase()}</span>`;
    if (systemTitle) systemTitle.textContent = `${name} â€” Select System`;
    window.currentCategory = name;

    // header back stays hidden; use pill back inside category
    if (BACK_BTN) BACK_BTN.style.display = 'none';
  }

  // handle selecting an actual system (call existing selectSystem)
  function handleSelectSystem(systemName){
    if (typeof window.selectSystem === 'function') {
      window.selectSystem(systemName);
    } else {
      document.getElementById('selectionPage').style.display = 'none';
      document.getElementById('systemPage').style.display = 'block';
      document.getElementById('systemTitle').textContent = systemName;
    }
  }

  // event delegation on the container
  container.addEventListener('click', function(ev){
    const target = ev.target.closest('[data-action]');
    if (!target) return;

    const action = target.getAttribute('data-action');
    if (action === 'abnormal') {
      showCategory('Abnormal Working');
      return;
    }
    if (action === 'select-system') {
      const sys = target.getAttribute('data-system');
      if (sys) handleSelectSystem(sys);
      return;
    }
    if (action === 'back-home') {
      showHome();
      return;
    }
  });

  // keyboard accessibility: treat Enter & Space on block elements same as click
  container.addEventListener('keydown', function(ev){
    if (ev.key !== 'Enter' && ev.key !== ' ') return;
    const target = ev.target.closest('[data-action]');
    if (!target) return;
    ev.preventDefault();
    target.click();
  });

  // expose for debugging / external use
  window.showHome = showHome;
  window.showCategory = showCategory;

  // initialize home on load
  document.addEventListener('DOMContentLoaded', showHome, { once: true });

})();
</script>

</body>
</html>
